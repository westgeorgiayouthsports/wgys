import{j as e,y as me,l as xe}from"./index-lWfxYzVq.js";import{u as ye,r as u}from"./vendor-router-Ck4ZuSP9.js";import{a as Q,u as be}from"./vendor-redux-BbD-gcRX.js";import{f as Z,a as J}from"./analyticsClient-cghBTDXY.js";import{S as N,B as we,ax as je,x as ve,V as U,W as L,X as v,H as $,$ as R,a0 as ee,ay as te}from"./vendor-antd-CieyQibU.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-firebase-BzUsRx-X.js";const{Title:Se,Text:y}=ve;function Ce(){const se=ye(),g=Q(s=>s.theme.isDarkMode),ne=be(),S=Q(s=>s.ui?.websiteViewsRange||30),[V,w]=u.useState(0),[B,H]=u.useState(void 0),[E,ae]=u.useState(void 0),[D,oe]=u.useState(!1),[re,F]=u.useState(!0),[ie,G]=u.useState(!1),[p,W]=u.useState(S),[le,P]=u.useState([]),[ce,de]=u.useState(void 0),[Y,ue]=u.useState("line"),I=!0;u.useEffect(()=>{(async()=>{try{F(!0);const{views:t,healthy:n,realtimeViews:a,source:o}=await J(),r=typeof t=="number"?t:Number(t||0),i=typeof a=="number"?a:Number(a||0),d=r===0&&i>0?i:r;w(d),H(i),ae(o),oe(n)}catch(t){console.error("Failed to load analytics:",t)}finally{F(!1)}})(),A(p)},[]),u.useEffect(()=>{S!==p&&(W(S),A(S))},[S]),u.useEffect(()=>{(async()=>{try{const{timeseries:t}=await Z(p);if(t&&t.length){const n=t.reduce((a,o)=>a+o.views,0);w(n)}else{const{views:n,realtimeViews:a}=await J(),o=typeof n=="number"?n:Number(n||0),r=typeof a=="number"?a:Number(a||0),i=o===0&&r>0?r:o;w(i)}}catch(t){console.error("Failed to load ranged metrics",t)}})()},[p]);const A=async s=>{G(!0);try{const{timeseries:t,source:n,views:a,realtimeViews:o}=await Z(s),r=[],i=new Date,d=new Map((t||[]).map(l=>[l.date,l.views]));if(s===1){const l=new Date,x=new Date(l);x.setMinutes(0,0,0),x.setHours(x.getHours()-1);const j=new Date(x);j.setHours(x.getHours()-23);for(let M=0;M<24;M++){const k=new Date(j);k.setHours(j.getHours()+M);const z=k.getFullYear(),_=String(k.getMonth()+1).padStart(2,"0"),X=String(k.getDate()).padStart(2,"0"),q=String(k.getHours()).padStart(2,"0"),K=`${z}${_}${X}${q}`,ge=Number(d.get(K)||0),pe=new Date(Number(z),Number(_)-1,Number(X),Number(q)).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});r.push({date:K,views:ge,source:n,label:pe})}}else for(let l=s-1;l>=0;l--){const x=new Date(i);x.setDate(i.getDate()-l);const j=x.toISOString().slice(0,10).replace(/-/g,""),M=Number(d.get(j)||0);r.push({date:j,views:M,source:n})}P(r),de(n);const m=r.reduce((l,x)=>l+(x.views||0),0),b=typeof a=="number"?a:Number(a||0),f=typeof o=="number"?o:Number(o||0);if(m>0)w(m);else if(f>0)w(f);else if(typeof a=="number"){const l=b===0&&f>0?f:b;w(l)}typeof o=="number"&&H(o)}catch(t){console.error("Failed to load trends",t),P([])}finally{G(!1)}},he=[1,7,30,90,180,365],c=le.map(s=>{const t=s.date;if(s.label)return{...s};if(t&&t.length===8){const n=t.slice(0,4),a=t.slice(4,6),o=t.slice(6,8);return{...s,label:`${a}/${o}/${n}`}}if(t&&t.length===10){const n=Number(t.slice(0,4)),a=Number(t.slice(4,6)),o=Number(t.slice(6,8)),r=Number(t.slice(8,10)),d=new Date(n,a-1,o,r).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return{...s,label:d}}return{...s,label:s.date}}),O=12,h=(()=>{if(c.length<=O)return c;const s=Math.ceil((c.length-1)/(O-1)),t=[];for(let n=0;n<c.length;n+=s)t.push(c[n]);return t[t.length-1]?.date!==c[c.length-1]?.date&&t.push(c[c.length-1]),t})(),C=(()=>{if(!h.length)return"";const s=h.map(i=>i.views),t=Math.max(...s),n=Math.min(...s),a=t-n||1,o=600,r=200;return h.map((i,d)=>{const m=d/Math.max(1,h.length-1)*o,b=r-(i.views-n)/a*r;return`${d===0?"M":"L"}${m.toFixed(2)},${b.toFixed(2)}`}).join(" ")})(),fe=(()=>{if(!h.length)return[];const s=h.map(i=>i.views),t=Math.max(...s,1),n=600,a=200,o=4,r=Math.max(8,n/Math.max(1,h.length)-o);return h.map((i,d)=>{const m=d*(r+o),b=i.views/t*a,f=a-b;return{x:m,y:f,height:b,width:r}})})(),T=(()=>{if(c.length<2)return{change:null,pct:null};if(c.reduce((f,l)=>f+(l.views||0),0)===0)return{change:null,pct:null};const t=Math.min(3,c.length),n=c.slice(0,t),a=c.slice(c.length-t),o=n.reduce((f,l)=>f+(l.views||0),0)/t,r=a.reduce((f,l)=>f+(l.views||0),0)/t;if(o===0&&r===0)return{change:null,pct:null};const i=Math.round(r-o),d=o===0?r>0?100:0:i/o*100,m=Math.round(d),b=(m>0?`+${m}`:`${m}`)+"%";return{change:i,pct:b}})();return e.jsxs("div",{style:{padding:"32px",backgroundColor:g?"#141414":"#fafafa",color:g?"#ffffff":"rgba(0, 0, 0, 0.85)",minHeight:"100vh"},children:[e.jsx(N,{style:{marginBottom:"32px"},children:e.jsx(we,{type:"text",icon:e.jsx(je,{}),onClick:()=>se("/admin/dashboard"),children:"Back to Dashboard"})}),e.jsx(Se,{level:2,style:{margin:0,marginBottom:"8px"},children:"Analytics & Metrics"}),e.jsx(y,{type:"secondary",style:{marginBottom:"32px",display:"block"},children:"Track your website performance and engagement metrics"}),e.jsxs(U,{spinning:re,children:[e.jsxs(L,{gutter:[24,24],style:{marginBottom:"32px"},children:[e.jsx(v,{xs:24,sm:12,lg:8,children:e.jsxs($,{hoverable:!0,style:{backgroundColor:g?"#1f1f1f":"#ffffff"},children:[e.jsx(R,{title:"Data Status",value:D?"Active":"Pending",styles:{content:{color:D?"#52c41a":"#faad14"}}}),e.jsx(y,{type:"secondary",style:{fontSize:"12px",marginTop:"8px",display:"block"},children:D?V===0?"Connected: no views reported yet":"Analytics data is being tracked":"GA4 Cloud Function not yet deployed"})]})}),e.jsx(v,{xs:24,sm:12,lg:8,children:e.jsxs($,{hoverable:!0,style:{backgroundColor:g?"#1f1f1f":"#ffffff"},children:[e.jsx(R,{title:"Realtime (Last ~30m)",value:typeof B=="number"?B:"—",styles:{content:{color:"#722ed1"}}}),e.jsxs(y,{type:"secondary",style:{fontSize:"12px",marginTop:"8px",display:"block"},children:["Source: ",E||"pending"]})]})})]}),e.jsx(L,{gutter:[24,24],children:e.jsx(v,{xs:24,children:e.jsx($,{title:"Analytics Details",hoverable:!0,style:{backgroundColor:g?"#1f1f1f":"#ffffff"},children:e.jsxs(N,{orientation:"vertical",style:{width:"100%"},children:[e.jsxs("div",{children:[e.jsx(y,{strong:!0,children:"Google Analytics 4 Property ID:"}),e.jsx(y,{code:!0,style:{marginLeft:"8px"},children:me("VITE_FIREBASE_GA4_PROPERTY_ID")||"514640984"}),e.jsxs("div",{role:"status","aria-live":"polite",className:`showing-tag ${p===1?"showing-pulse":""}`,children:["Range: ",p,"d"]}),e.jsx(ee,{color:I?"green":"default",style:{marginLeft:"8px"},children:I?"Enabled":"Disabled"})]}),e.jsxs("div",{children:[e.jsx(y,{strong:!0,children:"Data Source:"}),e.jsx(y,{style:{marginLeft:"8px"},children:"Firebase Cloud Functions (GA4 Data API, realtime fallback)"})]}),e.jsxs("div",{children:[e.jsx(y,{strong:!0,children:"Setup Status:"}),e.jsx(ee,{color:D?"green":"orange",style:{marginLeft:"8px"},children:D?"Active":"Deployment Required"})]})]})})})})]}),e.jsx($,{title:`Website Page Views (${p}d)`,hoverable:!0,style:{marginTop:24,backgroundColor:g?"#1f1f1f":"#ffffff"},extra:e.jsxs(N,{children:[e.jsx(te,{options:he.map(s=>({label:`${s===365?"1y":s===180?"6m":`${s}d`}`,value:s})),value:p,onChange:s=>{const t=Number(s);W(t);try{ne({type:"ui/setWebsiteViewsRange",payload:t})}catch(n){xe.error("Failed to set website views range in global state",n)}A(t)}}),e.jsx(te,{options:[{label:"Line",value:"line"},{label:"Bars",value:"bar"}],value:Y,onChange:s=>ue(s)})]}),children:e.jsx(U,{spinning:ie,children:c.length?e.jsxs("div",{children:[e.jsxs(L,{gutter:[16,16],style:{marginBottom:24},children:[e.jsxs(v,{xs:24,sm:8,children:[e.jsx(R,{title:`Total Views (${p}d)`,value:V,styles:{content:{color:"#1890ff"}}}),e.jsxs(y,{type:"secondary",style:{fontSize:"12px"},children:["Source: ",ce||E||"pending"]})]}),e.jsx(v,{xs:24,sm:8,children:e.jsx(R,{title:`Daily Average (${p}d)`,value:V>0?Math.round(V/p):0,suffix:"views/day",styles:{content:{color:"#52c41a"}}})}),e.jsx(v,{xs:24,sm:8,children:e.jsx(R,{title:"Change",value:T.change??"—",suffix:T.pct??"",styles:{content:{color:T.change==null?void 0:T.change>=0?"#52c41a":"#f5222d"}}})})]}),e.jsx("div",{style:{width:"100%",overflowX:"auto",padding:"8px 0"},children:Y==="line"?e.jsxs("svg",{width:"100%",height:"240",viewBox:"0 0 600 240",preserveAspectRatio:"xMidYMid meet",style:{minWidth:"600px"},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"trendGradient",x1:"0",x2:"0",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#1890ff",stopOpacity:"0.4"}),e.jsx("stop",{offset:"100%",stopColor:"#1890ff",stopOpacity:"0.05"})]})}),C?e.jsxs("g",{children:[e.jsx("path",{d:`${C} L600,200 L0,200 Z`,fill:"url(#trendGradient)",stroke:"none"}),e.jsx("path",{d:C,fill:"none",stroke:"#1890ff",strokeWidth:2.5,strokeLinecap:"round",strokeLinejoin:"round"})]}):null,h.map((s,t)=>{const n=t/Math.max(1,h.length-1)*600;return e.jsx("text",{x:n,y:220,textAnchor:"middle",fontSize:"10",fill:g?"#888":"#666",children:s.label?.split("/").slice(0,2).join("/")},`label-${t}`)})]}):e.jsxs("svg",{width:"100%",height:"240",viewBox:"0 0 600 240",preserveAspectRatio:"xMidYMid meet",style:{minWidth:"600px"},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"barGradient",x1:"0",x2:"0",y1:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#1890ff",stopOpacity:"0.9"}),e.jsx("stop",{offset:"100%",stopColor:"#1890ff",stopOpacity:"0.4"})]})}),fe.map((s,t)=>e.jsx("rect",{x:s.x,y:s.y,width:s.width,height:s.height,rx:2,fill:"url(#barGradient)"},`${s.x}-${t}`)),h.map((s,t)=>{const n=Math.max(8,600/Math.max(1,h.length)-4),a=t*(n+4)+n/2;return e.jsx("text",{x:a,y:220,textAnchor:"middle",fontSize:"10",fill:g?"#888":"#666",children:s.label?.split("/").slice(0,2).join("/")},`label-${t}`)})]})})]}):e.jsx(y,{type:"secondary",children:"No trend data yet for this range."})})})]})}export{Ce as default};
