import{j as t,e as M,l as f}from"./index-lWfxYzVq.js";import{r as i,c as ee,u as se}from"./vendor-router-Ck4ZuSP9.js";import{o as z,n as ae,x as te}from"./vendor-firebase-BzUsRx-X.js";import{a as re}from"./vendor-redux-BbD-gcRX.js";import{A as ne}from"./AdminPageHeader-BidreVSQ.js";import{s as l}from"./firebaseSeasons-BgcPTcUq.js";import{p as I}from"./firebasePrograms-DQfL_YhU.js";import{x as oe,Q as n,B as x,ab as ie,H as ce,ac as de,a2 as le,a8 as F,M as ue,a0 as $,S as pe,af as me,ag as b,K as fe,T as ge,ah as he}from"./vendor-antd-CieyQibU.js";import{S as ye}from"./SeasonEditor-B8zJWRm3.js";import{g as Se}from"./prefs-BrreBWug.js";import{S as o}from"./season-CjhZh6iC.js";import"./vendor-react-Ck9bq5u-.js";import"./firebaseTeams-DYGNnM-E.js";import"./slugify-IzZIKjBC.js";const{Title:xe,Text:C}=oe,we={spring:"blue",summer:"green",fall:"orange",winter:"geekblue"},ve={spring:"Spring",summer:"Summer",fall:"Fall",winter:"Winter"};function $e(){const{role:Y,user:u}=re(e=>e.auth),[g,R]=i.useState([]),[N,A]=i.useState(!0),[B,w]=i.useState(!1),[h,v]=i.useState(null),[y,L]=i.useState(o.active),U=Se("seasonsPageSize")??15,[k,P]=i.useState({current:1,pageSize:U}),[K,E]=i.useState({}),[V,H]=i.useState([]),T=i.useRef(null);if(Y!=="admin"&&Y!=="owner")return t.jsxs("div",{style:{padding:"64px",textAlign:"center"},children:[t.jsx(xe,{level:2,type:"danger",children:"Access Denied"}),t.jsx(C,{type:"secondary",children:"You need admin or owner privileges to access this page."})]});i.useEffect(()=>{S(),Q()},[]);const j=ee(),D=se();i.useEffect(()=>{const s=new URLSearchParams(j.search).get("openSeason");if(s&&g.length>0){const a=g.find(r=>r.id===s);a&&setTimeout(()=>G(a),50)}},[j.search,g]);const Q=async()=>{if(u?.uid)try{const e=z(M,`users/${u.uid}/preferences`),s=await ae(e);if(s.exists()){const a=s.val();a.seasonsPageSize&&P(r=>({...r,pageSize:a.seasonsPageSize}))}}catch(e){f.error("Failed to load user preferences for seasons:",e)}},W=async e=>{if(u?.uid)try{const s=z(M,`users/${u.uid}/preferences`);await te(s,{seasonsPageSize:e})}catch(s){console.error("Failed to save seasons pageSize preference:",s)}},S=async()=>{A(!0);try{const s=(await l.getSeasons()).sort((a,r)=>new Date(r.createdAt).getTime()-new Date(a.createdAt).getTime());R(s);try{const a=await I.getPrograms();H(a||[]);const r={};(a||[]).forEach(p=>{const c=p.seasonId||(p.season&&typeof p.season=="string"?p.season:void 0);c&&(r[c]=(r[c]||0)+1)}),E(r)}catch(a){console.error("Error loading programs for season counts",a),E({})}}catch(e){f.error("Error loading seasons:",e),n.error("Failed to load seasons")}finally{A(!1)}},G=e=>{v(e),w(!0)},J=async e=>{try{await l.archiveSeasonCascade(e,u?.uid||void 0),await S(),n.success("Season and all related programs/teams archived")}catch(s){f.error("Error archiving season:",s),n.error("Failed to archive season")}},O=async e=>{try{return await I.unlinkProgram(e),n.success("Program unlinked from season"),await S(),!0}catch(s){return f.error("Error unlinking program from season",s),n.error("Failed to unlink program"),!1}},q=async e=>{try{await l.deleteSeason(e,u?.uid||void 0),await S();try{const s=await l.getSeasonById(e);if(s){f.error("Delete reported success but season still exists on server",{seasonId:e,still:s}),n.error("Delete reported success but season still exists — check server logs");return}}catch(s){f.error("Error verifying season deletion",s)}w(!1),v(null),D("/admin/seasons",{replace:!0}),n.success("Season deleted")}catch(s){f.error("Error deleting season:",s);const a=s&&s.message?s.message:String(s);n.error(a||"Failed to delete season")}},X=async e=>{try{const s=(e.name||"").trim().toLowerCase();if(s&&g.find(m=>(m.name||"").trim().toLowerCase()===s&&m.id!==h?.id)){n.error("A season with that name already exists");return}let a=e.seasonType,r=e.year;if(!a&&e.startDate){const d=l.deriveSeasonMeta(e.startDate.format("YYYY-MM-DD"));a=d.type,r=d.year}if(a&&r&&g.find(m=>m.seasonType===a&&m.year===r&&m.id!==h?.id)){n.error("A season with that type and year already exists");return}const p=e.startDate?e.startDate.format("YYYY-MM-DD"):void 0,c={name:e.name,seasonType:e.seasonType,year:e.year,startDate:p,description:e.description,status:e.status||o.draft};if(p&&(!c.seasonType||!c.year)){const d=l.deriveSeasonMeta(p);c.seasonType=d.type,c.year=d.year}if(h)await l.updateSeason(h.id,{...c},u?.uid||void 0),n.success("Season updated successfully");else{const d=await l.createSeason(c,u?.uid||""),m=await l.getSeasonById(d);v(m),n.success("Season created successfully"),await S(),w(!0)}}catch(s){f.error("Error saving season:",s),n.error(s?.message||"Failed to save season")}},Z=[{title:"Season Name",dataIndex:"name",key:"name",width:150,render:e=>t.jsx(C,{strong:!0,children:e})},{title:"ID",dataIndex:"id",key:"id",width:150,render:e=>t.jsx(C,{strong:!0,children:e})},{title:"Type",key:"seasonType",width:75,render:e=>t.jsx($,{color:we[e.seasonType],children:ve[e.seasonType]})},{title:"Year",dataIndex:"year",key:"year",width:50},{title:"Start Date",dataIndex:"startDate",key:"startDate",width:140,render:e=>e?F(e).format("MMM D, YYYY"):"-"},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0},{title:"Created",key:"createdAt",width:150,render:e=>F(e.createdAt).format("MMM D, YYYY")},{title:"Status",key:"status",width:100,render:e=>t.jsx($,{color:e.status===o.active?"green":e.status===o.archived?"red":"default",children:e.status===o.active?"Active":e.status===o.archived?"Archived":"Draft"})},{title:"Actions",key:"actions",width:220,render:e=>{const a=(K[e.id]||0)===0,r=e.status!==o.active&&e.status!==o.archived;return t.jsxs(pe,{children:[t.jsx(x,{size:"small",icon:t.jsx(me,{}),onClick:()=>D(`/admin/seasons?openSeason=${e.id}`,{state:{from:j.pathname+j.search}}),disabled:e.status===o.archived,children:"Edit"}),r&&t.jsx(b,{title:"Archive Season",description:"This will archive all programs and teams in this season. Continue?",onConfirm:()=>J(e.id),okText:"Yes",cancelText:"No",children:t.jsx(x,{size:"small",icon:t.jsx(fe,{}),children:"Archive"})}),t.jsx(b,{title:"Delete Season",description:a?"Are you sure you want to delete this season?":"Cannot delete season with programs assigned",onConfirm:()=>a?q(e.id):void 0,okText:"Yes",cancelText:"No",children:t.jsx(ge,{title:a?"Delete season":"Season has programs; cannot delete",children:t.jsx(x,{size:"small",danger:!0,icon:t.jsx(he,{}),disabled:!a})})})]})}}],_={expandedRowRender:e=>{const s=V.filter(a=>a.seasonId===e.id);return!s||s.length===0?t.jsx("div",{style:{color:"#888"},children:"No programs linked to this season"}):t.jsx("div",{children:s.map(a=>t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 0",borderBottom:"1px solid #f0f0f0"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:600},children:a.name}),t.jsxs("div",{style:{color:"#666"},children:[a.sport||""," — ",a.ageGroup||""," ",a.basePrice!=null?`— $${a.basePrice}`:""]})]}),t.jsx("div",{children:t.jsx(b,{title:`Unlink program '${a.name}' from this season?`,onConfirm:()=>O(a.id),okText:"Yes",cancelText:"No",children:t.jsx(x,{size:"small",children:"Unlink"})},`unlink-${a.id}`)})]},a.id))})}};return t.jsxs("div",{className:"page-container",children:[t.jsx(ne,{title:"Seasons",subtitle:"Manage program seasons",actions:t.jsx(x,{type:"primary",icon:t.jsx(ie,{}),onClick:()=>D("/admin/seasons/new"),children:"New Season"})}),t.jsxs(ce,{title:"Season Directory",children:[t.jsx("div",{style:{marginBottom:12,display:"flex",gap:8,alignItems:"center",justifyContent:"flex-start"},children:(()=>{const e=[{key:"active",label:"Active"},{key:"draft",label:"Draft"},{key:"closed",label:"Closed"},{key:"archived",label:"Archived"},{key:"all",label:"All"}];return t.jsx(de,{activeKey:y,onChange:s=>L(s),items:e})})()}),t.jsx(le,{columns:Z,dataSource:g.filter(e=>y==="all"?!0:y==="active"?e.status===o.active:y==="archived"?e.status===o.archived:y==="closed"?e.status===o.closed:y==="draft"?e.status===o.draft:!0),expandable:_,rowKey:"id",pagination:{current:k.current,pageSize:k.pageSize,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,s)=>`${s[0]}-${s[1]} of ${e} seasons`,onChange:(e,s)=>{P({current:e,pageSize:s||15}),s&&s!==k.pageSize&&W(s||15)}},loading:N,size:"middle"})]}),t.jsx(ue,{title:h?"Edit Season":"Create New Season",open:B,onCancel:()=>{w(!1),T.current?.reset(),v(null)},onOk:()=>T.current?.submit(),children:t.jsx(ye,{ref:T,season:h,onFinish:X})})]})}export{$e as default};
