import{o as y,q as m,n as f,t as w,A as E,B as P,N as S}from"./vendor-firebase-BzUsRx-X.js";import{e as c,q as l,A as u,l as d}from"./index-lWfxYzVq.js";const x={async getPaymentMethodsByUser(r,t=!1){try{const e=y(c,"paymentMethods"),o=E(e,P("userId"),S(r)),a=await f(o);if(!a.exists())return[];const n=[];return a.forEach(s=>{const i=s.val();i&&i.deleted&&!t||n.push({id:s.key,...i})}),n}catch(e){throw d.error("Error fetching payment methods:",e),e}},async createPaymentMethod(r,t,e,o,a,n,s){try{const i=y(c,"paymentMethods"),p=w(i),M=(await this.getPaymentMethodsByUser(r)).length===0,h={userId:r,type:t,brand:o,last4:e,isDefault:M,createdAt:new Date().toISOString()};a!==void 0&&(h.expMonth=a),n!==void 0&&(h.expYear=n),s!==void 0&&(h.stripePaymentMethodId=s),await m(p,h);try{await l.log({action:"paymentMethod.created",entityType:u.PaymentMethod,entityId:p.key??null,details:{userId:r,type:t,brand:o,last4:e,isDefault:M}})}catch(g){d.error("Error auditing paymentMethod.created:",g)}return{id:p.key,...h}}catch(i){throw d.error("Error creating payment method:",i),i}},async deletePaymentMethod(r){try{const t=y(c,`paymentMethods/${r}`),e=new Date().toISOString(),o=await f(t),a=o.exists()?o.val():null;await m(t,{...a||{},deleted:!0,deletedAt:e,updatedAt:e});try{await l.logDelete(u.PaymentMethod,r,a)}catch(n){d.error("Error auditing paymentMethod.delete:",n)}}catch(t){throw d.error("Error deleting paymentMethod:",t),t}},async restorePaymentMethod(r){try{const t=y(c,`paymentMethods/${r}`),e=await f(t),o=e.exists()?e.val():null,a=new Date().toISOString(),n={...o||{},deleted:!1,deletedAt:null,updatedAt:a};await m(t,n);try{return await l.log({action:"paymentMethod.restored",entityType:u.PaymentMethod,entityId:r,details:{before:o}})??null}catch(s){return d.error("Error auditing paymentMethod.restored:",s),null}}catch(t){throw d.error("Error restoring paymentMethod:",t),t}},async setDefaultPaymentMethod(r,t){try{const e=await this.getPaymentMethodsByUser(r);for(const o of e){const a=y(c,`paymentMethods/${o.id}`);await m(a,{...o,isDefault:o.id===t,updatedAt:new Date().toISOString()});try{await l.log({action:o.id===t?"paymentMethod.set_default":"paymentMethod.unset_default",entityType:u.PaymentMethod,entityId:o.id,details:{userId:r,methodId:o.id}})}catch(n){d.error(`Error auditing ${o.id===t?"paymentMethod.set_default":"paymentMethod.unset_default"}:`,n)}}}catch(e){throw d.error("Error setting default payment method:",e),e}}};export{x as p};
