import{j as s}from"./index-lWfxYzVq.js";import{f as J,u as Q,r as n}from"./vendor-router-Ck4ZuSP9.js";import{a as Z}from"./vendor-redux-BbD-gcRX.js";import{A as _}from"./AdminPageHeader-BidreVSQ.js";import{p as k}from"./firebasePrograms-DQfL_YhU.js";import{s as ee}from"./firebaseSeasons-BgcPTcUq.js";import{p as se}from"./firebaseProgramRegistrations-CcV5GOOA.js";import{t as c}from"./firebaseTeams-DYGNnM-E.js";import{F as ae,G as m,x as re,B as i,ax as te,H as I,S as T,ab as ne,d as v,aa as oe,W as ie,X as E,a2 as R,a0 as u,M as le,I as A}from"./vendor-antd-CieyQibU.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-firebase-BzUsRx-X.js";import"./slugify-IzZIKjBC.js";import"./season-CjhZh6iC.js";const{Title:N,Text:B}=re;function ve(){const{programId:l}=J(),S=Q(),{role:w}=Z(e=>e.auth),{message:o}=ae.useApp(),[r,U]=n.useState(null),[z,G]=n.useState([]),[M,C]=n.useState(!0),[$,P]=n.useState(!1),[L,H]=n.useState([]),[d,b]=n.useState([]),[D,K]=n.useState([]),[f,F]=n.useState(void 0),[V,h]=n.useState(!1),[p]=m.useForm();n.useEffect(()=>{l&&(W(),x(),q(),y())},[l]);const y=async()=>{try{const a=(await c.getTeams()||[]).filter(t=>!t.programId);K(a)}catch(e){console.error("❌ Error loading unassigned teams:",e)}},q=async()=>{try{const[,e]=await Promise.all([k.getPrograms(),ee.getSeasons()]);G(e||[])}catch(e){console.error("❌ Error loading programs/seasons:",e)}},O=e=>{if(!e)return"";if(e.season&&typeof e.season=="object"&&e.season.name)return e.season.name;const a=e.seasonId||(typeof e.season=="string"?e.season:void 0);return z.find(g=>g.id===a)?.name||a||""},W=async()=>{C(!0);try{const a=(await k.getPrograms()).find(t=>t.id===l)||null;U(a),a||o.error("Program not found")}catch(e){console.error("❌ Error loading program:",e),o.error("Failed to load program")}finally{C(!1)}},x=async()=>{if(l){P(!0);try{const[e,a]=await Promise.all([se.getProgramRegistrationsByProgram(l),c.getTeamsByProgram(l)]);H(e||[]),b(a||[])}catch(e){console.error("❌ Error loading team assignment data:",e),o.error("Failed to load team assignment data")}finally{P(!1)}}},j=e=>{for(const a of d)if((a.rosterAthleteIds||[]).includes(e))return a.id},X=async(e,a)=>{try{if(!a)return;const t=await c.getTeamById(a);if(!t)return;const g=Array.from(new Set([...t.rosterAthleteIds||[],e]));await c.updateTeam(a,{rosterAthleteIds:g}),await x(),o.success("Athlete assigned to team")}catch(t){console.error("❌ Error assigning athlete:",t),o.error("Failed to assign athlete")}},Y=async e=>{try{if(!r)return;const a=await c.createTeam({name:e.name,budget:0,spent:0,status:"active",programId:r.id,seasonId:r.seasonId||r.season?.id||void 0,year:r.year,ageGroup:r.ageGroup});h(!1),p.resetFields(),b([...d,a]),o.success("Team created")}catch(a){console.error("❌ Error creating team:",a),o.error("Failed to create team")}};return w!=="admin"&&w!=="owner"?s.jsxs("div",{style:{padding:"64px",textAlign:"center"},children:[s.jsx(N,{level:2,type:"danger",children:"Access Denied"}),s.jsx(B,{type:"secondary",children:"You need admin or owner privileges to access this page."})]}):M||!r?s.jsx("div",{children:"Loading..."}):s.jsxs("div",{className:"page-container",children:[s.jsx(_,{title:s.jsx(s.Fragment,{children:s.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center"},children:[s.jsx(i,{icon:s.jsx(te,{}),onClick:()=>S("/admin/programs"),children:"Back to Programs"}),s.jsxs("div",{children:[s.jsx(N,{level:2,style:{margin:0},children:(r?.season?.name?`${r.season.name} - `:"")+r.name}),s.jsx(B,{type:"secondary",children:"Team Assignment"})]})]})}),actions:s.jsx(i,{onClick:()=>S(`/admin/programs/${r.id}`),children:"Program Details"})}),s.jsxs(I,{title:"Team Assignment",children:[s.jsxs(T,{style:{marginBottom:16},children:[s.jsx(i,{type:"primary",icon:s.jsx(ne,{}),onClick:()=>h(!0),children:"Create Team"}),s.jsx(v,{style:{width:260},placeholder:"Assign existing team to this program",value:f,onChange:e=>F(e),options:D.map(e=>({label:e.name||e.id,value:e.id})),allowClear:!0}),s.jsx(i,{onClick:async()=>{if(!(!f||!r))try{await c.updateTeam(f,{programId:r.id,seasonId:r.seasonId||r.season?.id||void 0,year:r.year,ageGroup:r.ageGroup}),o.success("Team assigned to program"),F(void 0),await x(),await y()}catch(e){console.error("❌ Error assigning team:",e),o.error("Failed to assign team")}},children:"Assign"}),s.jsx(i,{icon:s.jsx(oe,{}),onClick:()=>{x(),y()},loading:$,children:"Refresh"})]}),s.jsxs(ie,{gutter:16,children:[s.jsx(E,{xs:24,xl:12,children:s.jsx(I,{size:"small",title:`Teams (${d.length})`,children:s.jsx(R,{size:"small",rowKey:"id",dataSource:d,pagination:!1,scroll:{x:!0},columns:[{title:"Name",dataIndex:"name",key:"name"},{title:"Roster",key:"roster",render:e=>e.rosterAthleteIds?.length||0},{title:"Staff",key:"staff",render:e=>s.jsxs(T,{wrap:!0,children:[s.jsxs(u,{color:e.coachId?"green":"default",children:["Head Coach",e.coachId?"":": none"]}),s.jsxs(u,{color:e.teamManagerId?"blue":"default",children:["Manager",e.teamManagerId?"":": none"]}),s.jsxs(u,{color:(e.assistantCoachIds?.length||0)>0?"purple":"default",children:["Assistants: ",e.assistantCoachIds?.length||0]})]})}]})})}),s.jsx(E,{xs:24,xl:12,children:s.jsx(I,{size:"small",title:"Eligible Athletes",children:s.jsx(R,{size:"small",rowKey:"id",dataSource:(L||[]).filter(e=>(e.status||"pending")==="confirmed"),pagination:!1,scroll:{x:!0},columns:[{title:"Athlete",key:"athlete",render:e=>e.playerName||e.athleteId},{title:"Program",dataIndex:"programName",key:"programName"},{title:"Assigned Team",key:"assigned",render:e=>{const a=e.athleteId?j(e.athleteId):void 0,t=d.find(g=>g.id===a)?.name;return s.jsx(u,{color:t?"blue":"default",children:t||"Unassigned"})}},{title:"Status",key:"status",render:e=>{const a=e.athleteId?j(e.athleteId):void 0;return s.jsx(u,{color:a?"green":"orange",children:a?"Assigned":"Unassigned"})}},{title:"Assign",key:"assign",render:e=>s.jsx(v,{size:"small",placeholder:"Select team",style:{width:180},onChange:a=>X(e.athleteId,a),value:j(e.athleteId),children:d.map(a=>s.jsx(v.Option,{value:a.id,children:a.name},a.id))})}]})})})]})]}),s.jsx(le,{title:"Create Team",open:V,onCancel:()=>{h(!1),p.resetFields()},footer:null,width:500,children:s.jsxs(m,{form:p,layout:"vertical",onFinish:Y,children:[s.jsx(m.Item,{name:"name",label:"Team Name",rules:[{required:!0}],children:s.jsx(A,{placeholder:"Enter team name"})}),s.jsx(m.Item,{label:"Season",children:s.jsx(A,{value:O(r),disabled:!0})}),s.jsx(m.Item,{label:"Program",children:s.jsx(A,{value:r.name,disabled:!0})}),s.jsx(m.Item,{style:{textAlign:"right",marginBottom:0},children:s.jsxs(T,{children:[s.jsx(i,{onClick:()=>{h(!1),p.resetFields()},children:"Cancel"}),s.jsx(i,{type:"primary",htmlType:"submit",children:"Create"})]})})]})})]})}export{ve as default};
