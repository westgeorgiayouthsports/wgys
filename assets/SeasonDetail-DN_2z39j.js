import{l as g,j as t}from"./index-lWfxYzVq.js";import{f as F,u as I,r as y}from"./vendor-router-Ck4ZuSP9.js";import{s as r}from"./firebaseSeasons-BgcPTcUq.js";import{S as v}from"./season-CjhZh6iC.js";import{a as R}from"./vendor-redux-BbD-gcRX.js";import{S as T}from"./SeasonEditor-B8zJWRm3.js";import{Q as o,S as E,B as u,ax as _,x as N,af as O,H as b}from"./vendor-antd-CieyQibU.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-firebase-BzUsRx-X.js";import"./firebasePrograms-DQfL_YhU.js";import"./slugify-IzZIKjBC.js";import"./firebaseTeams-DYGNnM-E.js";const{Title:L}=N;function W(){const{seasonId:l}=F(),c=I(),[a,h]=y.useState(null),[x,m]=y.useState(!1),{user:j}=R(e=>e.auth),Y=y.useRef(null),w=window.__wgys_location__||void 0,D=w&&w.state?.from||void 0;if(y.useEffect(()=>{if(!l){c("/admin/seasons");return}if(l==="new"){h(null),m(!0);return}(async()=>{try{const e=await r.getSeasonById(l);if(!e){o.error("Season not found"),c("/admin/seasons");return}h(e)}catch(e){g.error("Error loading season",e),o.error("Failed to load season")}})()},[l]),!a&&!x)return t.jsx("div",{style:{padding:24},children:"Loading..."});const C=async e=>{try{try{const s=await r.getSeasons(),M=(e.name||"").trim().toLowerCase();if(M&&s.find(d=>(d.name||"").trim().toLowerCase()===M&&d.id!==a?.id)){o.error("A season with that name already exists");return}let f=e.seasonType,S=e.year;if(!f&&e.startDate){const p=r.deriveSeasonMeta(e.startDate.format("YYYY-MM-DD"));f=p.type,S=p.year}if(f&&S&&s.find(d=>d.seasonType===f&&d.year===S&&d.id!==a?.id)){o.error("A season with that type and year already exists");return}}catch(s){g.error("Could not perform client-side duplicate check",s)}const n=e.startDate?e.startDate.format("YYYY-MM-DD"):void 0,k=e.registrationOpen?e.registrationOpen.format("YYYY-MM-DD"):void 0,B=e.registrationClose?e.registrationClose.format("YYYY-MM-DD"):void 0,i={name:e.name,seasonType:e.seasonType,year:e.year,startDate:n,registrationOpen:k,registrationClose:B,description:e.description,status:e.status||v.draft};if(n&&(!i.seasonType||!i.year)){const s=r.deriveSeasonMeta(n);i.seasonType=s.type,i.year=s.year}if(a&&a.id){await r.updateSeason(a.id,i,j?.uid||void 0);const s=await r.getSeasonById(a.id);h(s),o.success("Season updated"),m(!1)}else{const s=await r.createSeason(i,j?.uid||"");o.success("Season created"),c(`/admin/seasons/${s}`)}}catch(n){g.error("Save failed",n),o.error(n?.message||"Failed to save season")}};return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[t.jsxs(E,{orientation:"vertical",style:{flex:1},children:[t.jsx(u,{icon:t.jsx(_,{}),onClick:()=>{if(D)return c(D);c(-1)},children:"Back"}),t.jsx("div",{children:t.jsx(L,{level:2,style:{margin:0},children:a?.name||"New Season"})})]}),t.jsx(E,{children:x?t.jsxs(t.Fragment,{children:[t.jsx(u,{type:"primary",onClick:()=>Y.current?.submit(),children:"Save"}),t.jsx(u,{onClick:()=>m(!1),children:"Cancel"})]}):t.jsx(u,{icon:t.jsx(O,{}),onClick:()=>m(!0),children:"Edit"})})]}),t.jsx(b,{children:x?t.jsx(T,{ref:Y,season:a,onFinish:C}):t.jsx(T,{season:a,onFinish:C,readOnly:!0})})]})})}export{W as default};
