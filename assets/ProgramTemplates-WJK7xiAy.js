import{e as h,q as C,A as k,l as d,j as a,F as fe,P as xe}from"./index-lWfxYzVq.js";import{u as je,r as m}from"./vendor-router-Ck4ZuSP9.js";import{a as Se}from"./vendor-redux-BbD-gcRX.js";import{a as S}from"./firebasePrograms-DQfL_YhU.js";import{n as F,o as y,z as be,x as Pe,t as we}from"./vendor-firebase-BzUsRx-X.js";import{s as ve}from"./firebaseSeasons-BgcPTcUq.js";import{s as Ie}from"./firebaseSports-DK6SYh6x.js";import{G as l,Q as u,B as I,ab as Te,aF as De,H as Fe,a2 as Oe,M as _,d as p,ad as R,ak as H,a9 as G,a8 as b,S as Ae,af as Ee,a0 as Me}from"./vendor-antd-CieyQibU.js";import{A as Ye}from"./AdminPageHeader-BidreVSQ.js";import{s as Ce}from"./slugify-IzZIKjBC.js";import"./vendor-react-Ck9bq5u-.js";import"./season-CjhZh6iC.js";import"./firebaseTeams-DYGNnM-E.js";const K={async getSeasonPrograms(){try{const r=await F(y(h,"seasonPrograms"));if(!r.exists())return[];const s=r.val();return Object.entries(s).map(([o,i])=>({id:o,...i}))}catch(r){return d.error("Error fetching seasonPrograms",r),[]}},async getBySeason(r){try{const s=await F(y(h,"seasonPrograms"));if(!s.exists())return[];const o=s.val();return Object.entries(o).map(([i,g])=>({id:i,...g})).filter(i=>i.seasonId===r)}catch(s){return d.error("Error fetching seasonPrograms by season",s),[]}},async getById(r){try{const s=await F(y(h,`seasonPrograms/${r}`));return s.exists()?{id:r,...s.val()}:null}catch(s){return d.error("Error fetching seasonProgram",s),null}},async createSeasonProgram(r,s){try{const o=new Date().toISOString(),i={...r,enabled:r.enabled??!0,createdAt:o,updatedAt:o,createdBy:s||null},g=await we(y(h,"seasonPrograms"),i);try{await C.log({action:"seasonProgram.created",entityType:k.SeasonProgram,entityId:g.key,details:i})}catch(P){d.error("Audit log failed",P)}return g.key}catch(o){throw d.error("Error creating seasonProgram",o),o}},async updateSeasonProgram(r,s){try{const o={...s,updatedAt:new Date().toISOString()};await Pe(y(h,`seasonPrograms/${r}`),o);try{await C.log({action:"seasonProgram.updated",entityType:k.SeasonProgram,entityId:r,details:o})}catch(i){d.error("Audit log failed",i)}}catch(o){throw d.error("Error updating seasonProgram",o),o}},async deleteSeasonProgram(r){try{const s=await F(y(h,`seasonPrograms/${r}`)),o=s.exists()?s.val():null;await be(y(h,`seasonPrograms/${r}`));try{await C.log({action:"seasonProgram.deleted",entityType:k.SeasonProgram,entityId:r,details:o})}catch(i){d.error("Audit log failed",i)}}catch(s){throw d.error("Error deleting seasonProgram",s),s}}};function Ue(){const{role:r,user:s}=Se(e=>e.auth),o=je(),[i,g]=m.useState([]),[P,f]=m.useState(null),[Q,x]=m.useState(!1),[B,U]=m.useState([]),[$,J]=m.useState([]),[W,X]=m.useState([]),[N,L]=m.useState(!0),[Z,w]=m.useState(!1),[j,O]=m.useState(null),[ee,A]=m.useState(!1),[T,ae]=m.useState(null),[v]=l.useForm(),[E]=l.useForm();if(m.useEffect(()=>{M()},[]),r!=="admin"&&r!=="owner")return a.jsx("div",{style:{padding:48},children:"Access Denied"});const M=async()=>{L(!0);try{const[e,t,n,c]=await Promise.all([S.getTemplates(),ve.getSeasons(),Ie.getSports(),K.getSeasonPrograms()]);g(e),U(t),J(n||[]),X(c||[])}catch(e){d.error("Error loading templates",e),u.error("Failed to load")}finally{L(!1)}},te=()=>{O(null),v.resetFields(),f(null),x(!1),w(!0)},se=e=>{O(e),v.setFieldsValue({...e}),f(e.id),x(!1),w(!0)},re=async e=>{try{await S.deleteTemplate(e,s?.uid),g(i.filter(t=>t.id!==e)),u.success("Template deleted")}catch(t){d.error("Error deleting template",t),u.error("Failed to delete")}},ne=e=>{if(j){f(j.id),x(!1);return}const t=e.sportId||"",n=e.programType||"";if(t&&n){const c=Ce(`${t}-${n}`);f(c);const D=i.find(Y=>Y.id===c);x(!!D)}else f(null),x(!1)},oe=async e=>{try{if(j)await S.updateTemplate(j.id,e,s?.uid),g(i.map(t=>t.id===j.id?{...t,...e}:t)),u.success("Template updated");else{const t=await S.createTemplate(e,s?.uid),n=await S.getTemplateById(t);O(n),f(t),x(!1),u.success("Template created"),await M(),w(!0);return}w(!1),v.resetFields()}catch(t){d.error("Error saving template",t),u.error("Save failed")}},ie=e=>{ae(e),E.resetFields(),A(!0)},le=async e=>{if(T)try{const t={seasonId:e.seasonId,programId:T.id,enabled:e.isOpenForRegistration??!0,basePrice:e.feeOverride??T.defaultBaseFee??null,registrationOpen:e.registrationOpen?b(e.registrationOpen).format("YYYY-MM-DD"):null,registrationClose:e.registrationClose?b(e.registrationClose).format("YYYY-MM-DD"):null,createdBy:s?.uid||null};await K.createSeasonProgram(t,s?.uid),u.success("Template attached to season"),A(!1)}catch(t){d.error("Error attaching template to season",t),u.error("Attach failed")}},de=[{title:"Sport",key:"sport",render:e=>{const t=$.find(n=>n.id===e.sportId);return t?t.name:e.sportId||"-"}},{title:"Type",key:"programType",render:e=>fe(e.programType)},{title:"Template ID",dataIndex:"id",key:"id"},{title:"Default Fee",dataIndex:"defaultBaseFee",key:"defaultBaseFee",render:e=>e?`$${e}`:"-"},{title:"Status",key:"active",render:e=>a.jsx(ke,{active:!!e.active})},{title:"Actions",key:"actions",render:e=>a.jsxs(Ae,{children:[a.jsx(I,{size:"small",icon:a.jsx(Ee,{}),onClick:()=>se(e),children:"Edit"}),a.jsx(I,{size:"small",onClick:()=>ie(e),children:"Attach to Season"}),a.jsx(I,{size:"small",danger:!0,onClick:()=>re(e.id),children:"Delete"})]})}],ce={expandedRowRender:e=>{const t=W.filter(n=>n.programId===e.id);return!t||t.length===0?a.jsx("div",{style:{color:"#888"},children:"Not attached to any seasons"}):a.jsx("div",{children:t.map(n=>{const c=B.find(ye=>ye.id===n.seasonId),D=e,Y=n.enabled!==void 0&&n.enabled!==null?n.enabled:D.active??!1,V=n.basePrice!==void 0&&n.basePrice!==null?n.basePrice:D.defaultBaseFee??null,me=V!=null?`$${V}`:"-",q=n.registrationOpen?"seasonProgram":c?.startDate?"season":void 0,z=n.registrationClose?"seasonProgram":c?.endDate?"season":void 0,ue=q==="seasonProgram"?b(n.registrationOpen).format("MMM D, YYYY"):q==="season"?b(c.startDate).format("MMM D, YYYY"):"-",pe=z==="seasonProgram"?b(n.registrationClose).format("MMM D, YYYY"):z==="season"?b(c.endDate).format("MMM D, YYYY"):"-",ge=ue,he=pe;return a.jsxs("div",{style:{marginBottom:8},children:[a.jsx(Me,{color:"blue",style:{cursor:"pointer"},onClick:()=>o(`/admin/seasons/${c?c.id:n.seasonId}`),children:c?c.name:n.seasonId}),a.jsx("span",{style:{marginLeft:8,marginRight:12},children:Y?"Open":"Closed"}),a.jsxs("span",{style:{marginRight:12},children:["Fee: ",me]}),a.jsxs("span",{children:["Reg: ",ge," â†’ ",he]})]},n.id)})})}};return a.jsxs("div",{className:"page-container",children:[a.jsx(Ye,{title:"Program Templates",actions:a.jsxs("div",{style:{display:"flex",gap:8},children:[a.jsx(I,{type:"primary",icon:a.jsx(Te,{}),onClick:te,disabled:N,children:"New Template"}),a.jsx(I,{onClick:async()=>{try{const e=await S.ensureDefaultProgramTemplates();e&&e.length?u.success(`Created defaults: ${e.join(", ")}`):u.info("Default program templates already present"),await M()}catch(e){d.error("Failed to ensure default templates",e);const t=e&&e.message?e.message:String(e);t.toLowerCase().includes("permission")||t.includes("PERMISSION_DENIED")?De.error({message:"Permission denied",description:"Your Firebase Realtime Database rules prevented writing program templates. As an admin, either run the server-side seed script (`npm run seed:program-templates` with a service account and `FIREBASE_DATABASE_URL`) or update your RTDB rules to allow admin writes.",duration:10}):u.error("Failed to ensure defaults")}},children:"Ensure Defaults"})]})}),a.jsx(Fe,{children:a.jsx(Oe,{dataSource:i,columns:de,rowKey:"id",loading:N,expandable:ce})}),a.jsx(_,{open:Z,title:j?"Edit Template":"New Template",onCancel:()=>w(!1),onOk:()=>v.submit(),children:a.jsxs(l,{form:v,layout:"vertical",onFinish:oe,onValuesChange:e=>ne(e),children:[a.jsx(l.Item,{name:"sportId",label:"Sport",rules:[{required:!0}],children:a.jsx(p,{children:$.map(e=>a.jsx(p.Option,{value:e.id,children:e.name},e.id))})}),a.jsxs(l.Item,{label:"Template ID (computed)",children:[a.jsx(R,{style:{display:"none"}}),a.jsx("input",{value:P||"",readOnly:!0,style:{width:"100%",fontFamily:"monospace",border:"1px solid #d9d9d9",padding:"6px 8px",borderRadius:2}}),P&&Q&&a.jsx("div",{style:{color:"#d46b08",marginTop:6},children:"ID already exists; a unique suffix will be appended on save."}),!P&&a.jsx("div",{style:{color:"#777",marginTop:6},children:"ID will be generated from sport and program type (e.g., baseball-recreation)."})]}),a.jsx(l.Item,{name:"sex",label:"Sex Restriction",children:a.jsxs(p,{allowClear:!0,children:[a.jsx(p.Option,{value:"any",children:"Any"}),a.jsx(p.Option,{value:"male",children:"Male"}),a.jsx(p.Option,{value:"female",children:"Female"})]})}),a.jsx(l.Item,{name:"programType",label:"Program Type",rules:[{required:!0}],children:a.jsx(p,{children:xe.map(e=>a.jsx(p.Option,{value:e.value,children:e.label},e.value))})}),a.jsx(l.Item,{name:"defaultBaseFee",label:"Default Base Fee",children:a.jsx(R,{min:0,style:{width:"100%"}})}),a.jsx(l.Item,{name:"active",label:"Active",valuePropName:"checked",children:a.jsx(H,{})})]})}),a.jsx(_,{open:ee,title:`Attach ${T?.id??""} to Season`,onCancel:()=>A(!1),onOk:()=>E.submit(),children:a.jsxs(l,{form:E,layout:"vertical",onFinish:le,children:[a.jsx(l.Item,{name:"seasonId",label:"Season",rules:[{required:!0}],children:a.jsx(p,{children:B.map(e=>a.jsx(p.Option,{value:e.id,children:e.name},e.id))})}),a.jsx(l.Item,{name:"isOpenForRegistration",label:"Open for Registration",valuePropName:"checked",children:a.jsx(H,{})}),a.jsx(l.Item,{name:"registrationOpen",label:"Registration Open",children:a.jsx(G,{style:{width:"100%"}})}),a.jsx(l.Item,{name:"registrationClose",label:"Registration Close",children:a.jsx(G,{style:{width:"100%"}})}),a.jsx(l.Item,{name:"feeOverride",label:"Fee Override (dollars)",children:a.jsx(R,{min:0,style:{width:"100%"}})})]})})]})}function ke({active:r}){return a.jsx("span",{style:{color:r?"green":"gray"},children:r?"Active":"Inactive"})}export{Ue as default};
