import{e as $,l as x,j as e,t as as,p as Ce}from"./index-lWfxYzVq.js";import{r as m}from"./vendor-router-Ck4ZuSP9.js";import{u as ls,a as Ne}from"./vendor-redux-BbD-gcRX.js";import{o as U,n as q,x as de,w as rs}from"./vendor-firebase-BzUsRx-X.js";import{f as ce,v as ns}from"./firebaseFiles-ka_SnfIb.js";import{p as g}from"./firebasePeople-B5ZBKo1U.js";import{familiesService as T}from"./firebaseFamilies-CHrcTgng.js";import{F as is,G as u,S as N,B as w,aa as os,al as ds,am as cs,ab as ms,x as us,W as B,X as j,H as Y,$ as K,b as E,an as me,ao as ue,g as he,ac as hs,V as ps,a2 as ys,M as V,I as v,a9 as fs,d as c,a0 as I,ai as pe,ap as xs,i as gs,ak as js,a8 as Fe,aq as Ae,p as ye,af as $e,ag as bs,ah as ws}from"./vendor-antd-CieyQibU.js";import{c as Ue,s as Oe}from"./storageService-BGD7Twul.js";import{c as vs}from"./age-BJnAeRxZ.js";import{g as Is}from"./prefs-BrreBWug.js";import{A as Ps}from"./AdminPageHeader-BidreVSQ.js";import"./vendor-react-Ck9bq5u-.js";const Ss={async syncUsersWithPeople(){const l={created:0,linked:0,errors:[]};try{const R=U($,"users"),f=await q(R);if(!f.exists())return l;const h=await g.getPeople(),O=new Map(h.filter(o=>o.userId).map(o=>[o.userId,o])),r=f.val();for(const[o,P]of Object.entries(r))try{const k=O.get(o);if(k)k.hasAccount||(await g.linkPersonToAccount(k.id,o),l.linked++);else{const F={firstName:P.displayName?.split(" ")[0]||"User",lastName:P.displayName?.split(" ").slice(1).join(" ")||"",email:P.email||"",roles:["parent"]},Z=await g.createPerson(F,o);await g.linkPersonToAccount(Z,o),l.created++}}catch(k){x.error(`Error syncing user ${o}:`,k),l.errors.push(`Failed to sync user ${o}: ${k}`)}return l}catch(R){return x.error("Error syncing users with people:",R),l.errors.push(`Sync failed: ${R}`),l}},async getUnlinkedUsers(){try{const l=U($,"users"),R=await q(l);if(!R.exists())return[];const f=await g.getPeople(),h=new Set(f.filter(o=>o.userId).map(o=>o.userId)),O=R.val(),r=[];for(const[o,P]of Object.entries(O))h.has(o)||r.push({uid:o,email:P.email||"No email",displayName:P.displayName||"Unknown User"});return r}catch(l){return x.error("Error getting unlinked users:",l),[]}}},{Title:ks,Text:p}=us;function Ts(){const{message:l}=is.useApp(),R=ls(),{role:f,user:h}=Ne(s=>s.auth),{isDarkMode:O}=Ne(s=>s.theme),[r,o]=m.useState([]),[P,k]=m.useState([]),[F,Z]=m.useState([]),[fe,xe]=m.useState(!0),[Me,D]=m.useState(!1),[d,_]=m.useState(null),[C,Be]=m.useState("all"),[J,L]=m.useState(null),[Ee,Q]=m.useState(!1),[W,ge]=m.useState(""),[X,je]=m.useState(""),De=Is("peoplePageSize")??15,[ee,be]=m.useState({current:1,pageSize:De}),[Le,we]=m.useState(!1),[ze,se]=m.useState(!1),[Te,te]=m.useState(!1),[Ye,ae]=m.useState(!1),[S,le]=m.useState(null),[re,ne]=m.useState(""),[y,z]=m.useState([]),[M]=u.useForm(),[ve,ie]=m.useState([]),[Ve,Ie]=m.useState(!1);m.useEffect(()=>{A(),oe(),G(),je(h?.displayName||""),ge(h?.photoURL||""),We()},[h]);const We=async()=>{if(h?.uid)try{const s=U($,`users/${h.uid}/preferences`),t=await q(s);if(t.exists()){const a=t.val();a.peoplePageSize&&be(n=>({...n,pageSize:a.peoplePageSize}))}}catch(s){x.error("Failed to load user preferences:",s)}},Ge=async s=>{if(h?.uid)try{const t=U($,`users/${h.uid}/preferences`);await de(t,{peoplePageSize:s})}catch(t){x.error("Failed to save user preferences:",t)}},G=async()=>{try{const s=await T.getFamilies();Z(s)}catch(s){x.error("âŒ Error loading families:",s)}},A=async()=>{xe(!0);try{const s=await g.getPeople();o(s)}catch(s){x.error("âŒ Error loading people:",s),l.error({content:"Failed to load people"})}finally{xe(!1)}},oe=async()=>{try{const s=U($,"users"),t=await q(s);if(!t.exists()){k([]);return}const a=t.val(),n=Object.entries(a).map(([i,b])=>({uid:i,displayName:b.displayName||b.email?.split("@")[0]||"Unknown User",email:b.email||"No email",systemRole:b.role||"user",createdAt:b.createdAt,updatedAt:b.updatedAt}));k(n)}catch(s){x.error("âŒ Error loading users:",s),l.error({content:"Failed to load users"})}},Pe=async(s,t)=>{try{const a=U($,`users/${s}`);await de(a,{role:t,updatedAt:new Date().toISOString()}),k(P.map(n=>n.uid===s?{...n,systemRole:t}:n)),L(null),l.success({content:`System role updated to ${t}`})}catch(a){x.error("âŒ Error updating role:",a),l.error({content:"Failed to update role"})}},He=async()=>{try{if(Ce.currentUser){await rs(Ce.currentUser,{displayName:X,photoURL:W||void 0});const s=U($,`users/${h?.uid}`);await de(s,{displayName:X,photoURL:W||null,updatedAt:new Date().toISOString()}),l.success({content:"Profile updated successfully"}),Q(!1)}}catch(s){x.error("âŒ Error updating profile:",s),l.error({content:"Failed to update profile"})}},Ke=()=>{_(null),M.resetFields(),D(!0)},qe=s=>{_(s),M.setFieldsValue({firstName:s.firstName,lastName:s.lastName,email:s.email,phone:s.phone,dateOfBirth:s.dateOfBirth?Fe(s.dateOfBirth):null,sex:s.sex,roles:s.roles,address:s.address,city:s.city,state:s.state,zipCode:s.zipCode,schoolName:s.schoolName,graduationYear:s.graduationYear,groups:s.groups}),D(!0)};m.useEffect(()=>{(async()=>{if(d&&(f==="admin"||f==="owner")&&d.familyId){Ie(!0);try{const s=await ce.getFilesByFamily(d.familyId);ie(s||[])}catch(s){x.error("Failed to load family files for admin view",s);const t=s;t&&(t.code==="PERMISSION_DENIED"||t.message&&t.message.toLowerCase().includes("permission"))?l.error("You do not have permission to access family files"):l.error("Failed to load family files")}finally{Ie(!1)}}else ie([])})()},[d,f]);const Ze=async s=>{try{await g.deletePerson(s),o(r.filter(t=>t.id!==s)),l.success({content:"Person deleted successfully"})}catch(t){x.error("âŒ Error deleting person:",t),l.error({content:"Failed to delete person"})}},_e=async()=>{we(!0);try{const s=await Ss.syncUsersWithPeople();s.errors.length>0?(l.warning({content:`Sync completed with ${s.errors.length} errors. Created: ${s.created}, Linked: ${s.linked}`,duration:5}),x.error("Sync errors:",s.errors)):l.success({content:`Sync completed successfully! Created: ${s.created} people, Linked: ${s.linked} accounts`,duration:3}),await Promise.all([A(),oe()])}catch(s){x.error("âŒ Error syncing users:",s),l.error({content:"Failed to sync users with people records"})}finally{we(!1)}},Je=async s=>{try{const t={...s,dateOfBirth:s.dateOfBirth?Fe(s.dateOfBirth).format("YYYY-MM-DD"):void 0};if(Object.keys(t).forEach(a=>{t[a]===void 0&&delete t[a]}),d)await g.updatePerson(d.id,t),o(r.map(a=>a.id===d.id?{...a,...t,updatedAt:new Date().toISOString()}:a)),l.success({content:"Person updated successfully"});else{const a=await g.createPerson(t,h?.uid||"");let n=t.familyId;if(!n&&(t.roles?.includes("parent")||t.roles?.includes("guardian"))){const b=`${t.lastName} Family`;n=await T.createFamily({name:b,primaryPersonId:a,memberIds:[a],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:h?.uid||""}),await g.updatePerson(a,{familyId:n})}const i={id:a,...t,familyId:n,hasAccount:!1,contactPreferences:[],programs:[],teams:[],groups:t.groups||[],source:"manual",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:h?.uid||"",isActive:!0};o([...r,i]),await G(),l.success({content:"Person added successfully"})}D(!1),M.resetFields()}catch(t){x.error("âŒ Error saving person:",t),l.error({content:"Failed to save person"})}},Qe=s=>({parent:"blue",guardian:"cyan",athlete:"green",grandparent:"magenta",relative:"geekblue",other:"default"})[s]||"default",Xe=s=>vs(s),es=[{title:"Name",key:"name",render:s=>{const t=P.find(a=>a.uid===s.userId);return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx(pe,{size:40,src:s.photoURL,icon:e.jsx(E,{}),style:{backgroundColor:s.hasAccount?t?.systemRole==="owner"?"#722ed1":t?.systemRole==="admin"?"#f5222d":t?.systemRole==="coach"?"#fa8c16":t?.systemRole==="teamManager"?"#1890ff":"#52c41a":"#d9d9d9"},onError:()=>!0}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:500},children:[s.firstName," ",s.lastName,s.hasAccount&&e.jsx(I,{color:t?.systemRole==="owner"?"purple":t?.systemRole==="admin"?"red":t?.systemRole==="coach"?"orange":t?.systemRole==="teamManager"?"blue":"green",style:{marginLeft:8},children:t?.systemRole==="owner"?"Owner Account":t?.systemRole==="admin"?"Admin Account":t?.systemRole==="coach"?"Coach Account":t?.systemRole==="teamManager"?"Team Manager Account":"User Account"})]}),e.jsx(p,{type:"secondary",children:s.email}),s.userId&&e.jsxs(p,{type:"secondary",style:{fontSize:"11px",fontFamily:"monospace"},children:["ID: ",s.userId.substring(0,8),"..."]}),t&&e.jsxs(p,{type:"secondary",style:{fontSize:"11px"},children:["ðŸ”— Linked to ",t.displayName||"User Account"]})]})]})}},{title:"Roles",key:"roles",render:s=>e.jsx("div",{children:(s.roles||[]).map(t=>e.jsx(I,{color:Qe(t),style:{marginBottom:"4px"},children:t},t))})},{title:"Contact",key:"contact",render:s=>e.jsxs("div",{children:[s.phone&&e.jsx("div",{children:s.phone}),s.dateOfBirth&&e.jsxs("div",{children:[e.jsx("div",{children:e.jsxs(p,{type:"secondary",children:["Age: ",Xe(s.dateOfBirth)]})}),s.roles?.includes("athlete")&&e.jsx("div",{style:{marginTop:4},children:e.jsxs(p,{type:"secondary",children:["Grade: ",(()=>{const t=Ue(s.graduationYear);return t===null?"â€”":t===0?"K":t})()]})})]})]})},{title:"Family",key:"family",render:s=>{if(!s.familyId)return e.jsx(p,{type:"secondary",children:"â€”"});const t=F.find(i=>i.id===s.familyId),a=r.find(i=>i.id===t?.primaryPersonId),n=r.filter(i=>i.familyId===s.familyId&&i.id!==s.id);return e.jsxs("div",{children:[e.jsx(I,{icon:e.jsx(ue,{}),color:"blue",style:{marginBottom:4},children:t?.name||"Family"}),a&&e.jsxs("div",{style:{fontSize:"12px",marginBottom:2},children:[e.jsx(p,{strong:!0,children:"Primary:"})," ",a.firstName," ",a.lastName]}),n.length>0&&e.jsx("div",{style:{fontSize:"12px",color:"#8c8c8c"},children:n.map(i=>`${i.firstName} ${i.lastName}`).join(", ")})]})}},{title:"Source",key:"source",render:s=>e.jsx(I,{color:s.source==="signup"?"green":s.source==="manual"?"orange":"blue",children:s.source})},{title:"System Role",key:"systemRole",render:s=>{const t=P.find(a=>a.uid===s.userId);return t?f==="owner"&&J===t.uid?e.jsxs(c,{value:t.systemRole,onChange:a=>Pe(t.uid,a),onBlur:()=>{L(null)},style:{width:120},autoFocus:!0,children:[e.jsx(c.Option,{value:"user",children:"User"}),e.jsx(c.Option,{value:"admin",children:"Admin"}),e.jsx(c.Option,{value:"coach",children:"Coach"}),e.jsx(c.Option,{value:"teamManager",children:"Team Manager"}),e.jsx(c.Option,{value:"owner",children:"Owner"})]}):e.jsxs(N,{children:[e.jsx(I,{icon:t.systemRole==="owner"?e.jsx(me,{}):t.systemRole==="admin"?e.jsx(Ae,{}):t.systemRole==="coach"?e.jsx(he,{}):t.systemRole==="teamManager"?e.jsx(ye,{}):e.jsx(E,{}),color:t.systemRole==="owner"?"purple":t.systemRole==="admin"?"red":t.systemRole==="coach"?"orange":t.systemRole==="teamManager"?"blue":"default",children:t.systemRole==="owner"?"Owner":t.systemRole==="admin"?"Admin":t.systemRole==="coach"?"Coach":t.systemRole==="teamManager"?"Team Manager":t.systemRole}),f==="owner"&&e.jsx(w,{size:"small",type:"link",onClick:()=>{L(t.uid)},children:"Edit"})]}):e.jsx(p,{type:"secondary",children:"â€”"})}},{title:"Actions",key:"actions",render:s=>e.jsxs(N,{children:[e.jsx(w,{size:"small",icon:e.jsx($e,{}),onClick:()=>{qe(s)},children:"Edit"}),s.userId===h?.uid&&e.jsx(w,{size:"small",icon:e.jsx(ye,{}),onClick:()=>{Q(!0)},children:"Profile"}),e.jsx(bs,{title:"Delete Person",description:"Are you sure you want to delete this person?",onConfirm:()=>{if(F.find(a=>a.id===s.familyId)?.primaryPersonId===s.id){le(s),ae(!0);return}Ze(s.id)},okText:"Yes",cancelText:"No",children:e.jsx(w,{size:"small",danger:!0,icon:e.jsx(ws,{}),children:"Delete"})})]})}],ss=[{title:"User",key:"user",render:s=>{const t=r.find(a=>a.userId===s.uid);return e.jsxs(N,{children:[e.jsx(pe,{icon:e.jsx(E,{}),style:{backgroundColor:s.systemRole==="owner"?"#722ed1":s.systemRole==="admin"?"#f5222d":"#8c8c8c"},children:(s.displayName||s.email||"U").charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsxs("div",{style:{fontWeight:500},children:[s.displayName||"Unknown User",!t&&e.jsx(I,{color:"orange",style:{marginLeft:8},children:"Unlinked"}),t&&e.jsx(I,{color:"green",style:{marginLeft:8},children:"Linked"})]}),e.jsx(p,{type:"secondary",children:s.email||"No email"}),t&&e.jsxs(p,{type:"secondary",style:{fontSize:"11px"},children:["ðŸ”— ",t.firstName," ",t.lastName]})]})]})}},{title:"System Role",key:"systemRole",render:s=>J===s.uid?e.jsxs(c,{value:s.systemRole,onChange:t=>Pe(s.uid,t),style:{width:120},children:[e.jsx(c.Option,{value:"user",children:"User"}),e.jsx(c.Option,{value:"admin",children:"Admin"}),e.jsx(c.Option,{value:"coach",children:"Coach"}),e.jsx(c.Option,{value:"teamManager",children:"Team Manager"}),f==="owner"&&e.jsx(c.Option,{value:"owner",children:"Owner"})]}):e.jsx(I,{icon:s.systemRole==="owner"?e.jsx(me,{}):s.systemRole==="admin"?e.jsx(Ae,{}):s.systemRole==="coach"?e.jsx(he,{}):s.systemRole==="teamManager"?e.jsx(ye,{}):e.jsx(E,{}),color:s.systemRole==="owner"?"purple":s.systemRole==="admin"?"red":s.systemRole==="coach"?"orange":s.systemRole==="teamManager"?"blue":"default",children:s.systemRole==="owner"?"Owner":s.systemRole==="admin"?"Admin":s.systemRole==="coach"?"Coach":s.systemRole==="teamManager"?"Team Manager":"User"})},{title:"Actions",key:"actions",render:s=>f==="owner"?J===s.uid?e.jsx(w,{size:"small",onClick:()=>{L(null)},children:"Cancel"}):e.jsx(w,{size:"small",icon:e.jsx($e,{}),onClick:()=>{L(s.uid)},children:"Edit Role"}):null}],ts=(()=>{switch(C){case"accounts":return r.filter(s=>s.hasAccount);case"families":return r.filter(s=>s.familyId);case"athletes":return r.filter(s=>(s.roles||[]).includes("athlete"));case"parents":return r.filter(s=>(s.roles||[]).includes("parent")||(s.roles||[]).includes("guardian"));default:return r}})(),Se=r.filter(s=>s.hasAccount),ke=r.filter(s=>s.familyId),Re=r.filter(s=>(s.roles||[]).includes("athlete"));return e.jsxs("div",{className:"page-container",children:[e.jsx(Ps,{title:e.jsxs(e.Fragment,{children:[e.jsx(ks,{level:2,style:{margin:0},children:"People Management"}),e.jsxs(p,{type:"secondary",children:[r.length," Total People"]})]}),actions:e.jsxs(N,{children:[e.jsx(w,{icon:e.jsx(os,{}),onClick:()=>C==="accounts"?oe():A(),loading:fe,children:"Refresh"}),(f==="admin"||f==="owner")&&e.jsx(w,{type:"default",loading:Le,onClick:_e,children:"Sync Users"}),e.jsxs(w,{icon:e.jsx(ds,{}),onClick:()=>se(!0),disabled:y.length<2,children:["Link Family (",y.length,")"]}),e.jsx(w,{icon:e.jsx(cs,{}),onClick:()=>te(!0),disabled:y.length!==2,children:"Merge Duplicates"}),e.jsx(w,{type:"primary",icon:e.jsx(ms,{}),onClick:Ke,children:"Add Person"})]})}),e.jsxs(B,{gutter:[16,16],style:{marginBottom:"24px"},children:[e.jsx(j,{xs:24,sm:6,children:e.jsx(Y,{children:e.jsx(K,{title:"Total People",value:r.length,prefix:e.jsx(E,{})})})}),e.jsx(j,{xs:24,sm:6,children:e.jsx(Y,{children:e.jsx(K,{title:"Account Holders",value:Se.length,prefix:e.jsx(me,{}),styles:{content:{color:"#52c41a"}}})})}),e.jsx(j,{xs:24,sm:6,children:e.jsx(Y,{children:e.jsx(K,{title:"Family Members",value:ke.length,prefix:e.jsx(ue,{}),styles:{content:{color:"#1890ff"}}})})}),e.jsx(j,{xs:24,sm:6,children:e.jsx(Y,{children:e.jsx(K,{title:"Athletes",value:Re.length,prefix:e.jsx(he,{}),styles:{content:{color:"#f5222d"}}})})})]}),e.jsxs(Y,{children:[e.jsx(hs,{activeKey:C,onChange:Be,items:[{key:"all",label:`All People (${r.length})`},{key:"accounts",label:`Account Holders (${Se.length})`},{key:"families",label:`Family Members (${ke.length})`},{key:"athletes",label:`Athletes (${Re.length})`},{key:"parents",label:`Parents (${r.filter(s=>(s.roles||[]).includes("parent")||(s.roles||[]).includes("guardian")).length})`}]}),e.jsx(ps,{spinning:fe,children:e.jsx(ys,{columns:C==="accounts"?ss:es,dataSource:C==="accounts"?P:ts,rowKey:C==="accounts"?"uid":"id",rowSelection:C!=="accounts"?{selectedRowKeys:y,onChange:s=>z(s)}:void 0,pagination:{current:ee.current,pageSize:ee.pageSize,showSizeChanger:!0,showQuickJumper:!0,showTotal:(s,t)=>`${t[0]}-${t[1]} of ${s} ${C==="accounts"?"users":"people"}`,onChange:(s,t)=>{be({current:s,pageSize:t||15}),t!==ee.pageSize&&Ge(t||15)}},locale:{emptyText:C==="accounts"?"No users found":"No people found"}})})]}),e.jsx(V,{title:d?"Edit Person":"Add New Person",open:Me,onCancel:()=>{D(!1),M.resetFields()},footer:null,width:800,children:e.jsxs(u,{form:M,layout:"vertical",onFinish:Je,children:[e.jsxs(B,{gutter:16,children:[e.jsx(j,{span:12,children:e.jsx(u.Item,{name:"firstName",label:"First Name",rules:[{required:!0,message:"Please enter first name"}],children:e.jsx(v,{placeholder:"Enter first name"})})}),e.jsx(j,{span:12,children:e.jsx(u.Item,{name:"lastName",label:"Last Name",rules:[{required:!0,message:"Please enter last name"}],children:e.jsx(v,{placeholder:"Enter last name"})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(j,{span:12,children:e.jsx(u.Item,{name:"email",label:"Email",rules:[{type:"email",message:"Please enter valid email"}],children:e.jsx(v,{placeholder:"Enter email address"})})}),e.jsx(j,{span:12,children:e.jsx(u.Item,{name:"phone",label:"Phone",children:e.jsx(v,{placeholder:"Enter phone number"})})})]}),e.jsxs(B,{gutter:16,children:[e.jsx(j,{span:8,children:e.jsx(u.Item,{name:"dateOfBirth",label:"Date of Birth",children:e.jsx(fs,{style:{width:"100%"},format:"YYYY-MM-DD",placeholder:"YYYY-MM-DD",allowClear:!0})})}),e.jsx(j,{span:8,children:e.jsx(u.Item,{name:"sex",label:"Sex",children:e.jsxs(c,{placeholder:"Select sex",children:[e.jsx(c.Option,{value:"male",children:"Male"}),e.jsx(c.Option,{value:"female",children:"Female"})]})})}),e.jsx(j,{span:8,children:e.jsx(u.Item,{name:"roles",label:"Relationship",rules:[{required:!0,message:"Please select at least one role"},{validator:ns}],children:e.jsxs(c,{mode:"multiple",placeholder:"Please select relationship",children:[e.jsx(c.Option,{value:"parent",children:"Parent"}),e.jsx(c.Option,{value:"guardian",children:"Guardian"}),e.jsx(c.Option,{value:"athlete",children:"Athlete/Child"}),e.jsx(c.Option,{value:"grandparent",children:"Grandparent"}),e.jsx(c.Option,{value:"relative",children:"Relative"}),e.jsx(c.Option,{value:"other",children:"Other"})]})})})]}),e.jsx(u.Item,{name:"address",label:"Address",children:e.jsx(v,{placeholder:"Enter street address"})}),e.jsxs(B,{gutter:16,children:[e.jsx(j,{span:8,children:e.jsx(u.Item,{name:"city",label:"City",children:e.jsx(v,{placeholder:"Enter city"})})}),e.jsx(j,{span:8,children:e.jsx(u.Item,{name:"state",label:"State",children:e.jsx(v,{placeholder:"Enter state"})})}),e.jsx(j,{span:8,children:e.jsx(u.Item,{name:"zipCode",label:"Zip Code",children:e.jsx(v,{placeholder:"Enter zip code"})})})]}),e.jsx(u.Item,{noStyle:!0,shouldUpdate:()=>!0,children:({getFieldValue:s})=>e.jsxs(B,{gutter:16,children:[e.jsx(j,{span:12,children:e.jsx(u.Item,{name:"schoolName",label:"School Name",children:e.jsx(v,{placeholder:"Enter school name"})})}),e.jsx(j,{span:12,children:(()=>{const t=s("graduationYear"),a=t?Number(t):void 0,n=a?Ue(a):null,i=n===null?null:n===0?"K":n,b=a?e.jsxs("span",{children:["Graduation Year (",e.jsxs(p,{type:"secondary",children:["Grade: ",i]}),")"]}):"Graduation Year";return e.jsx(u.Item,{name:"graduationYear",label:b,children:e.jsx(v,{type:"number",placeholder:"Enter graduation year"})})})()})]})}),e.jsx(u.Item,{label:"Family",children:e.jsxs(N,{orientation:"vertical",style:{width:"100%"},children:[!d&&e.jsx(u.Item,{name:"familyId",noStyle:!0,children:e.jsx(u.Item,{noStyle:!0,shouldUpdate:(s,t)=>s.lastName!==t.lastName,children:({getFieldValue:s})=>{const t=s("lastName");return e.jsx(c,{placeholder:t?`Create new: ${t} Family`:"Select existing family or create new",allowClear:!0,showSearch:!0,filterOption:(a,n)=>(n?.label??"").toLowerCase().includes(a.toLowerCase()),options:F.map(a=>{const n=r.find(i=>i.id===a.primaryPersonId);return{label:`${a.name} - ${n?.firstName||""} ${n?.lastName||""} (${n?.email||"No email"})`,value:a.id}})})}})}),d?.roles?.includes("athlete")&&!d?.familyId&&e.jsx("div",{style:{padding:8,background:"#fff7e6",border:"1px solid #ffd591",borderRadius:4,marginBottom:8},children:e.jsx(p,{type:"warning",children:"Athletes cannot be primary family members. Link this athlete to a parent/guardian instead."})}),d?.familyId?(()=>{const s=F.find(t=>t.id===d.familyId);return e.jsxs("div",{children:[e.jsx(I,{icon:e.jsx(ue,{}),color:"blue",style:{marginBottom:8},children:s?.name||d.familyId}),e.jsx("div",{style:{marginBottom:8,padding:12,border:"1px solid var(--ant-color-border)",borderRadius:4},children:r.filter(t=>t.familyId===d.familyId).map(t=>e.jsxs("div",{style:{marginBottom:4},children:[e.jsxs(I,{color:t.id===s?.primaryPersonId?"blue":"default",closable:t.id!==s?.primaryPersonId,onClose:async()=>{await g.updatePerson(t.id,{familyId:void 0}),A()},children:[t.firstName," ",t.lastName," ",t.id===s?.primaryPersonId&&"(Primary)"]}),t.email&&e.jsxs(p,{type:"secondary",style:{fontSize:"12px"},children:["(",t.email,")"]})]},t.id))}),e.jsx(w,{size:"small",danger:!0,onClick:async()=>{d?.id&&(await g.updatePerson(d.id,{familyId:void 0}),_({...d,familyId:void 0}),A())},children:"Unlink from Family"})]})})():null]})}),(f==="admin"||f==="owner")&&d?.familyId&&e.jsx(u.Item,{label:"Family Files",children:e.jsx("div",{style:{maxHeight:240,overflow:"auto",border:"1px solid var(--ant-color-border)",padding:8,borderRadius:4},children:Ve?e.jsx("div",{children:"Loading files..."}):e.jsxs("div",{children:[ve.length===0&&e.jsx("div",{children:"No files"}),ve.map(s=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 0",borderBottom:"1px dashed #f0f0f0"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:600},children:s.fileName}),e.jsxs("div",{style:{fontSize:12,color:"#8c8c8c"},children:[s.athleteId?`Athlete: ${(()=>{const t=r.find(a=>a.id===s.athleteId);return t?`${t.firstName} ${t.lastName}`:s.athleteId})()}`:"Family file"," â€¢ ",s.size?`${Math.round(s.size/1024)} KB`:"â€”"," â€¢ ",s.uploadedAt?new Date(s.uploadedAt).toLocaleString():"â€”"]})]}),e.jsxs("div",{children:[e.jsx("a",{href:"#",onClick:async t=>{t.preventDefault();try{const a=await Oe.getFileUrl(s.storagePath);window.open(a,"_blank")}catch{l.error("Failed to get file URL")}},children:"Download"}),(f==="admin"||f==="owner"||d&&h?.uid===s.uploaderId)&&e.jsx(w,{danger:!0,size:"small",style:{marginLeft:8},onClick:async()=>{try{await Oe.deleteFile(s.storagePath),await ce.deleteFamilyFile(d.familyId,s.id),l.success("File deleted");const t=await ce.getFilesByFamily(d.familyId);ie(t||[])}catch{l.error("Failed to delete file")}},children:"Delete"})]})]},s.id))]})})}),d?.userId&&e.jsx(u.Item,{label:"User ID",children:e.jsx(v,{value:d.userId,disabled:!0,style:{fontFamily:"monospace",fontSize:"12px"}})}),e.jsx(u.Item,{style:{marginBottom:0,textAlign:"right"},children:e.jsxs(N,{children:[e.jsx(w,{onClick:()=>{D(!1),M.resetFields()},children:"Cancel"}),e.jsx(w,{type:"primary",htmlType:"submit",children:d?"Update Person":"Add Person"})]})})]})}),e.jsx(V,{title:"Profile Settings",open:Ee,onCancel:()=>{Q(!1)},onOk:He,okText:"Save Changes",width:500,children:e.jsxs(N,{orientation:"vertical",size:"large",style:{width:"100%"},children:[e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx(pe,{size:80,src:W||h?.photoURL,icon:e.jsx(E,{}),style:{backgroundColor:"#00d4ff",marginBottom:16,cursor:"pointer"},onClick:()=>document.getElementById("photoUrlInput")?.focus()}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:500},children:"Profile Picture URL"}),e.jsx(v,{id:"photoUrlInput",placeholder:"Enter image URL or click avatar above",value:W,onChange:s=>{ge(s.target.value)},prefix:e.jsx(xs,{})})]})]}),e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:500},children:"Display Name"}),e.jsx(v,{value:X,onChange:s=>{je(s.target.value)},placeholder:"Enter display name",maxLength:50})]}),h?.uid&&e.jsxs("div",{children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:500},children:"User ID"}),e.jsx(v,{value:h.uid,disabled:!0,style:{fontFamily:"monospace",fontSize:"12px"}})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 0",borderTop:"1px solid #f0f0f0"},children:[e.jsxs(N,{children:[e.jsx(gs,{}),e.jsx("span",{children:O?"Dark Mode":"Light Mode"})]}),e.jsx(js,{checked:O,onChange:()=>R(as()),checkedChildren:"ðŸŒ™",unCheckedChildren:"â˜€ï¸"})]})]})}),e.jsxs(V,{title:"Link Family Members",open:ze,onCancel:()=>{se(!1),z([])},onOk:async()=>{if(y.length<2){l.warning({content:"Select at least 2 people to link"});return}try{const s=r.find(a=>a.id===y[0]);if(!s)return;if((s.roles||[]).includes("athlete")){l.error({content:"First person must be parent/guardian, not athlete"});return}const t=await T.createFamily({name:`${s.lastName} Family`,primaryPersonId:y[0],memberIds:y,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:h?.uid||""});for(const a of y)await g.updatePerson(a,{familyId:t});l.success({content:`Created family with ${y.length} members`}),se(!1),z([]),await Promise.all([A(),G()])}catch(s){l.error({content:"Failed to link family members"}),x.error("Failed to link family members",s)}},width:600,children:[e.jsx("div",{style:{marginBottom:16,padding:12,background:"#e6f7ff",borderRadius:4},children:e.jsx(p,{strong:!0,children:"First person selected will be the primary family member (must be parent/guardian)"})}),e.jsx(c,{mode:"multiple",style:{width:"100%"},placeholder:"Select people to link as family",value:y,onChange:z,filterOption:(s,t)=>(t?.label??"").toLowerCase().includes(s.toLowerCase()),options:r.filter(s=>!s.familyId).map(s=>({label:`${s.firstName} ${s.lastName} (${(s.roles||[]).join(", ")}) - ${s.email||"No email"}`,value:s.id}))})]}),e.jsx(V,{title:"Merge Duplicate People",open:Te,onCancel:()=>{te(!1)},onOk:async()=>{if(y.length===2)try{const s=r.find(i=>i.id===y[0]),t=r.find(i=>i.id===y[1]);if(!s||!t)return;const a={id:y[0]};["firstName","lastName","email","phone","dateOfBirth","sex","address","city","state","zipCode","schoolName","graduationYear"].forEach(i=>{const b=s[i],H=t[i];a[i]=document.querySelector(`input[name="merge-${i}"]:checked`)?.getAttribute("value")==="1"?b:H}),a.roles=[...new Set([...s.roles||[],...t.roles||[]])],await g.updatePerson(y[0],a),await g.deletePerson(y[1]),l.success({content:"People merged successfully"}),te(!1),z([]),A()}catch(s){l.error({content:"Failed to merge people"}),x.error("Failed to merge people",s)}},width:800,children:y.length===2?(()=>{const s=r.find(n=>n.id===y[0]),t=r.find(n=>n.id===y[1]);if(!s||!t)return null;const a=[{key:"firstName",label:"First Name"},{key:"lastName",label:"Last Name"},{key:"email",label:"Email"},{key:"phone",label:"Phone"},{key:"dateOfBirth",label:"Date of Birth"},{key:"sex",label:"Sex"},{key:"address",label:"Address"},{key:"city",label:"City"},{key:"state",label:"State"},{key:"zipCode",label:"Zip Code"},{key:"schoolName",label:"School"},{key:"graduationYear",label:"Graduation Year"}];return e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:16,padding:12,background:"#e6f7ff",borderRadius:4},children:e.jsx(p,{strong:!0,children:"Select which value to keep for each field. Person 2 will be deleted."})}),a.map(({key:n,label:i})=>{const b=s[n],H=t[n];return!b&&!H?null:e.jsxs("div",{style:{marginBottom:12,padding:8,border:"1px solid #f0f0f0",borderRadius:4},children:[e.jsx("div",{style:{fontWeight:500,marginBottom:8},children:i}),e.jsxs(N,{orientation:"vertical",children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer"},children:[e.jsx("input",{type:"radio",name:`merge-${n}`,value:"1",defaultChecked:!0,style:{marginRight:8}}),e.jsx(I,{color:"blue",children:"Person 1:"})," ",b||e.jsx(p,{type:"secondary",children:"Empty"})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",cursor:"pointer"},children:[e.jsx("input",{type:"radio",name:`merge-${n}`,value:"2",style:{marginRight:8}}),e.jsx(I,{color:"green",children:"Person 2:"})," ",H||e.jsx(p,{type:"secondary",children:"Empty"})]})]})]},n)})]})})():e.jsx(p,{type:"secondary",children:"Select exactly 2 people from the table using checkboxes"})}),e.jsx(V,{title:"Delete Primary Family Member",open:Ye,onCancel:()=>{ae(!1),le(null),ne("")},onOk:async()=>{if(!S)return;const s=F.find(a=>a.id===S.familyId);if(!s)return;const t=r.filter(a=>a.familyId===s.id&&a.id!==S.id&&(a.roles?.includes("parent")||a.roles?.includes("guardian")));if(t.length>0&&!re){l.error({content:"Please select a new primary member"});return}try{if(t.length>0)await T.updateFamily(s.id,{primaryPersonId:re}),await g.deletePerson(S.id),o(r.filter(a=>a.id!==S.id)),l.success({content:"Primary member changed and person deleted"});else{for(const a of s.memberIds)a!==S.id&&await g.updatePerson(a,{familyId:void 0});await T.deleteFamily(s.id),await g.deletePerson(S.id),o(r.filter(a=>a.id!==S.id)),l.success({content:"Person and family deleted successfully"})}ae(!1),le(null),ne(""),await Promise.all([A(),G()])}catch(a){l.error({content:"Failed to delete person"}),x.error("Failed to delete person",a)}},width:500,children:S&&(()=>{const s=F.find(a=>a.id===S.familyId);if(!s)return null;const t=r.filter(a=>a.familyId===s.id&&a.id!==S.id&&(a.roles?.includes("parent")||a.roles?.includes("guardian")));return e.jsx("div",{children:t.length>0?e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:16},children:e.jsx(p,{children:"This person is the primary family member. Please select a new primary member before deleting."})}),e.jsxs("div",{style:{marginBottom:16},children:[e.jsx("label",{style:{display:"block",marginBottom:8,fontWeight:500},children:"New Primary Member"}),e.jsx(c,{style:{width:"100%"},value:re,onChange:a=>ne(a),placeholder:"Select new primary member",options:t.map(a=>({label:`${a.firstName} ${a.lastName}`,value:a.id}))})]})]}):e.jsx("div",{children:e.jsx(p,{type:"warning",children:"This is the only adult in the family. Deleting this person will also delete the entire family and unlink all members."})})})})()})]})}export{Ts as default};
