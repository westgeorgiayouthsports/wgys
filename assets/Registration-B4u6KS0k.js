import{l as f,j as t}from"./index-lWfxYzVq.js";import{u as oe,f as ne,r as l}from"./vendor-router-Ck4ZuSP9.js";import{a as le}from"./vendor-redux-BbD-gcRX.js";import{t as de,Q as ce,x as me,W as z,a8 as g,X as N,H as $,B as I,a0 as B,S as fe}from"./vendor-antd-CieyQibU.js";import{c as ge}from"./storageService-BGD7Twul.js";import{c as w}from"./age-BJnAeRxZ.js";import{n as O,g as he,c as ue}from"./season-wVjdxr9p.js";import{s as ye}from"./firebaseSports-DK6SYh6x.js";import{p as xe}from"./firebasePrograms-DQfL_YhU.js";import{p as G}from"./firebaseProgramRegistrations-CcV5GOOA.js";import{s as pe}from"./firebaseSeasons-BgcPTcUq.js";import{p as U}from"./firebasePeople-B5ZBKo1U.js";import{p as je}from"./firebasePaymentMethods-CJsgpCPD.js";import{R as ve}from"./Register-Bha_xe8Q.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-firebase-BzUsRx-X.js";import"./slugify-IzZIKjBC.js";import"./season-CjhZh6iC.js";import"./firebaseTeams-DYGNnM-E.js";const{Title:L,Text:d}=me;function Oe(){const Y=oe(),{programId:y}=ne(),{user:h}=le(e=>e.auth),{token:W}=de.useToken(),[m,H]=l.useState([]),[M,R]=l.useState(null),[E,V]=l.useState([]),[q,K]=l.useState([]),[x,Q]=l.useState([]),[u,b]=l.useState(null),[_,X]=l.useState(null),[C,J]=l.useState({}),[Z,k]=l.useState(null),[A,ee]=l.useState([]);l.useEffect(()=>{te(),se()},[]),l.useEffect(()=>{(async()=>{try{const e=await ye.getSports();K(e||[])}catch(e){f.error("Failed to load sports:",e)}})()},[]),l.useEffect(()=>{if(y&&m.length>0){const e=m.find(s=>s.id===y);if(e){const o=new URLSearchParams(window.location.search).get("athleteId");o&&(R(e),b(o))}}},[y,m]),l.useEffect(()=>{(async()=>{try{if(!h)return;const e=await U.getPersonByUserId(h.uid);if(e&&e.familyId){const s=await U.getPeopleByFamily(e.familyId);Q(s||[]),X({name:`${e.firstName||""} ${e.lastName||""}`.trim(),email:h.email||"",phone:e.phone||""});try{const o=await G.getProgramRegistrationsByFamily(e.familyId),i={};o.forEach(r=>{r.athleteId&&(i[r.athleteId]=i[r.athleteId]||[],i[r.athleteId].push(r))}),J(i)}catch(o){f.error("Error loading registrations for family",o)}}}catch(e){f.error("Error loading family members",e)}})()},[h]);const te=async()=>{try{const s=(await xe.getPrograms()).filter(i=>i.active),o=await Promise.all(s.map(async i=>{try{const r=await G.getProgramRegistrationsByProgram(i.id),n=["pending","confirmed"],p=r.filter(j=>n.includes(j.status)).length;return{...i,currentRegistrants:p}}catch{return{...i,currentRegistrants:i.currentRegistrants||0}}}));H(o)}catch(e){try{const s=await pe.getSeasons();V(s||[])}catch(s){f.error("Failed to load seasons:",s)}f.error("Failed to load programs",e),ce.error("Failed to load programs")}},P=e=>{if(!e)return"";if(e.season&&typeof e.season=="object"&&e.season.name)return e.season.name;const s=e.seasonId||(typeof e.season=="string"?e.season:void 0);return E.find(i=>i.id===s)?.name||s||""},se=async()=>{if(h?.uid)try{const e=await je.getPaymentMethodsByUser(h.uid);ee(e)}catch(e){f.error("Failed to load payment methods",e)}},re=(e,s)=>s??ge(e),F=(e,s)=>{R(e);const o=A.find(p=>p.isDefault)||A[0];k(o?o.id:"new");const r=new URLSearchParams(window.location.search).get("athleteId"),n=s||r;n&&b(n)},T=(e,s,o)=>{if(!s)return{ok:!1,reason:"Please enter child date of birth"};const r=g(s).format("YYYY-MM-DD");if(e.birthDateStart){const n=g(e.birthDateStart).format("YYYY-MM-DD");if(r<n)return{ok:!1,reason:"Child is too old for this program"}}if(e.birthDateEnd){const n=g(e.birthDateEnd).format("YYYY-MM-DD");if(r>n)return{ok:!1,reason:"Child is too young for this program"}}return e.sexRestriction==="female"&&o!=="female"?{ok:!1,reason:"Program is for females only"}:e.sexRestriction==="male"&&o!=="male"?{ok:!1,reason:"Program is for males only"}:{ok:!0}};return t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:24},children:[t.jsx(L,{level:2,children:"Program Registration"}),t.jsx(d,{type:"secondary",children:"Register your child for an active program"})]}),x&&x.length>0&&t.jsxs("div",{style:{marginBottom:20},children:[t.jsx(L,{level:4,children:"Your Athletes"}),t.jsx(z,{gutter:[16,16],children:x.filter(e=>e.roles?.includes("athlete")).map(e=>{const s=C[e.id]||[],o=m.filter(a=>{const c=e.dateOfBirth,v=e.sex;if(!T(a,c,v).ok)return!1;const D=s.some(ie=>ie.programId===a.id);return a.maxParticipants!==void 0&&(a.currentRegistrants||0)>=a.maxParticipants?!1:!D}),i=u===e.id,r=M||(y?m.find(a=>a.id===y):void 0);let n=null;if(r)try{let a=O(r.season??{year:r.year,seasonType:r.season});if(!a||!a.year&&r.seasonId){const S=E.find(D=>D.id===r.seasonId);S&&(a=O(S))}const c=q.find(S=>S.id===r.sport)||void 0,v=he(a,c);n=ue(e.dateOfBirth,v)}catch(a){f.error("Failed to compute season age, falling back to program birthDateEnd or today",a),r.birthDateEnd?n=w(e.dateOfBirth,g(r.birthDateEnd)):n=w(e.dateOfBirth)}else n=w(e.dateOfBirth);const p=n===null?"—":n,j=e.grade!==void 0&&e.grade!==null?e.grade:re(e.graduationYear,e.grade),ae=j===null?"—":j===0?"K":j;return t.jsx(N,{xs:24,sm:12,md:8,children:t.jsxs($,{size:"small",title:t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:8},children:[t.jsxs("div",{style:{fontWeight:600},children:[e.firstName," ",e.lastName]}),t.jsx("div",{style:{textAlign:"center",minWidth:80},children:t.jsxs(d,{type:"secondary",children:["Age: ",p]})}),t.jsx("div",{style:{textAlign:"right",minWidth:80},children:t.jsxs(d,{type:"secondary",children:["Grade: ",ae]})})]}),style:i?{borderColor:"#1890ff"}:void 0,onClick:()=>b(e.id),hoverable:!0,children:[t.jsxs("div",{style:{marginBottom:8},children:[t.jsx(d,{strong:!0,children:"Registered"}),t.jsxs("div",{children:[s.length===0&&t.jsx("div",{children:t.jsx(d,{type:"secondary",children:"No registrations"})}),s.map(a=>t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:6},children:[t.jsx("div",{children:(()=>{const c=m.find(v=>v.id===a.programId);return c?`${P(c)?P(c)+" - ":""}${c.name}`:a.programId})()}),t.jsx("div",{children:t.jsx(I,{size:"small",onClick:()=>Y(`/register/confirmation/${a.id}`),children:"View"})})]},a.id))]})]}),t.jsxs("div",{children:[t.jsx(d,{strong:!0,children:"Eligible Programs"}),t.jsxs("div",{children:[o.length===0&&t.jsx("div",{children:t.jsx(d,{type:"secondary",children:"No eligible programs"})}),o.map(a=>t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginTop:6},children:[t.jsx("div",{children:a.name}),t.jsx("div",{children:t.jsx(I,{size:"small",type:"primary",onClick:()=>{b(e.id),F(a,e.id)},disabled:!i,children:"Register"})})]},a.id))]})]})]})},e.id)})})]}),t.jsx(z,{gutter:[16,16],children:m.map(e=>t.jsx(N,{xs:24,sm:12,md:8,children:t.jsxs($,{size:"small",title:`${P(e)?P(e)+" - ":""}${e.name}`,extra:t.jsxs(d,{strong:!0,children:["$",(e.basePrice||0).toFixed(2)]}),children:[t.jsx("div",{style:{marginBottom:8},children:t.jsxs(d,{type:"secondary",children:["Last Day: ",g(e.registrationClose).format("MMM D, YYYY")]})}),t.jsxs("div",{style:{marginBottom:12,paddingBottom:12,borderBottom:"1px solid #f0f0f0"},children:[t.jsx(d,{strong:!0,style:{fontSize:"12px",color:"#666"},children:"REQUIREMENTS"}),t.jsxs("div",{style:{marginTop:6},children:[e.sexRestriction==="female"&&t.jsx("div",{style:{marginBottom:4},children:t.jsx(B,{color:"magenta",children:"Female"})}),e.sexRestriction==="male"&&t.jsx("div",{style:{marginBottom:4},children:t.jsx(B,{color:"blue",children:"Male"})}),e.sexRestriction==="any"&&t.jsx("div",{style:{marginBottom:4},children:t.jsx(B,{color:"default",children:"Any"})}),(e.birthDateStart||e.birthDateEnd)&&t.jsx("div",{style:{marginBottom:4,fontSize:"12px"},children:t.jsxs(d,{type:"secondary",children:["Born: ",e.birthDateStart?g(e.birthDateStart).format("MMM YYYY"):"—"," to ",e.birthDateEnd?g(e.birthDateEnd).format("MMM YYYY"):"—"]})}),e.maxGrade!==void 0&&t.jsx("div",{style:{fontSize:"12px"},children:t.jsxs(d,{type:"secondary",children:["Up to Grade ",e.maxGrade===0?"K":e.maxGrade,e.allowGradeExemption&&t.jsx(d,{type:"warning",children:" (exemptions available)"})]})})]})]}),t.jsx("div",{style:{marginBottom:12},children:t.jsx("div",{style:{maxHeight:100,overflow:"auto",fontSize:"13px"},dangerouslySetInnerHTML:{__html:e.description||"No description available"}})}),t.jsxs(fe,{style:{marginTop:12},children:[(()=>{const s=u?x.find(i=>i.id===u):null;let o=!1;if(s){const i=T(e,s.dateOfBirth,s.sex),r=(C[s.id]||[]).some(n=>n.programId===e.id);o=i.ok&&!r}return t.jsx(I,{type:"primary",size:"small",onClick:()=>F(e,u||void 0),disabled:!s||!o||e.maxParticipants!==void 0&&(e.currentRegistrants||0)>=e.maxParticipants,children:"Register"})})(),t.jsx(I,{size:"small",onClick:()=>Y(`/programs/${e.id}`),children:"Details"})]})]})},e.id))}),M&&u&&t.jsx("div",{style:{position:"fixed",inset:0,zIndex:1400,background:"rgba(0,0,0,0.45)",overflow:"auto"},children:t.jsx("div",{style:{paddingTop:40},children:t.jsx("div",{style:{maxWidth:1e3,margin:"0 auto",background:W.colorBgElevated},children:t.jsx(ve,{program:M,athleteId:u,onClose:()=>{R(null)},isPreview:!1,familyMembers:x,parentInfo:_,defaultPaymentMethodId:Z})})})})]})}export{Oe as default};
