import{e as y,f as F,j as t,g as L,h as N}from"./index-lWfxYzVq.js";import{r as c,f as O,u as V}from"./vendor-router-Ck4ZuSP9.js";import{b as W,u as G,a as T}from"./vendor-redux-BbD-gcRX.js";import{o as j,z as H,A as k,B as D,D as R,E as U,t as Y,q as J,n as M}from"./vendor-firebase-BzUsRx-X.js";import{V as K,x as P,a3 as B,ai as $,b as Q,B as I,ah as X,S as Z,I as ee,aj as se,r as te,H as ae}from"./vendor-antd-CieyQibU.js";import{t as re}from"./firebaseTeams-DYGNnM-E.js";import"./vendor-react-Ck9bq5u-.js";const oe=s=>s.chat,ne=s=>W([oe],r=>{if(!r||!r.messages)return[];const e=s||"global";return r.messages[e]||[]}),E={_messagesPath(s){return s?`teamChats/${s}/messages`:"messages"},async getMessages(s){try{const r=this._messagesPath(s),e=j(y,r),u=k(e,D("timestamp"),R(100)),o=await M(u);if(!o.exists())return[];const l=[];return o.forEach(n=>{n.key&&l.push({id:n.key,...n.val()})}),l.sort((n,d)=>new Date(n.timestamp).getTime()-new Date(d.timestamp).getTime())}catch(r){throw console.error("Error fetching messages:",r),r}},async sendMessage(s,r,e,u){try{if(!e.trim())throw new Error("Message text cannot be empty");const o=this._messagesPath(u),l=j(y,o);let n;try{n=Y(l)}catch(x){throw new Error("Failed to create message reference: "+x.message)}const d=new Date().toISOString(),m={userId:s,userEmail:r,text:e,timestamp:d,read:!1};try{await J(n,m)}catch(x){throw new Error("Failed to save message to database: "+x.message)}return{id:n.key,userId:s,userEmail:r,text:e,timestamp:d,read:!1}}catch(o){throw console.error("Error sending message:",o),o}},subscribeToMessages(s,r){try{const e=this._messagesPath(r),u=j(y,e),o=k(u,D("timestamp"),R(100));return U(o,n=>{if(!n.exists()){s([]);return}const d=[];n.forEach(m=>{m.key&&d.push({id:m.key,...m.val()})}),s(d)})}catch(e){throw console.error("Error subscribing to messages:",e),e}},async deleteMessage(s,r){try{if(!s)throw new Error("Message ID is required");const e=this._messagesPath(r),u=j(y,`${e}/${s}`);try{await H(u)}catch(o){throw new Error("Failed to delete message from database: "+o.message)}}catch(e){throw console.error("Error deleting message:",e),e}}},{Text:S}=P;function ie({teamId:s}){const r=G(),e=T(a=>a.auth.user),u=c.useMemo(()=>ne(s),[s]),o=T(u),[l,n]=c.useState(""),[d,m]=c.useState(!1),[x]=c.useState(void 0),w=c.useRef(null);c.useEffect(()=>{if(!e?.uid)return;m(!0);let a=null,i=!0,g=null;try{a=E.subscribeToMessages(h=>{i&&(r(F({teamId:s,messages:h})),m(!1),g&&clearTimeout(g))},s),g=setTimeout(()=>{i&&m(!1)},5e3)}catch(h){console.error("Error loading messages:",h),i&&m(!1)}return()=>{i=!1,a&&a(),g&&clearTimeout(g)}},[e?.uid,r]),c.useEffect(()=>{w.current?.scrollIntoView({behavior:"smooth"})},[o]);const b=async a=>{if(a.preventDefault(),!(!e?.uid||!l.trim()))try{const i=await E.sendMessage(e.uid,e.email||"Unknown",l,s);r(L({teamId:s,message:i})),n("")}catch(i){console.error("Error sending message:",i)}},f=async a=>{try{await E.deleteMessage(a,s),r(N({teamId:s,id:a}))}catch(i){console.error("Error deleting message:",i)}};return t.jsxs("div",{style:{height:"400px",display:"flex",flexDirection:"column"},children:[t.jsxs("div",{style:{flex:1,overflowY:"auto",padding:"8px 0",marginBottom:"16px",borderBottom:"1px solid #f0f0f0"},children:[d&&t.jsxs("div",{style:{textAlign:"center",padding:"20px"},children:[t.jsx(K,{}),t.jsx(S,{type:"secondary",style:{display:"block",marginTop:"8px"},children:"Loading messages..."})]}),o.length===0&&!d&&t.jsx(B,{description:"No messages yet. Start the conversation!",image:B.PRESENTED_IMAGE_SIMPLE}),o.map(a=>t.jsx("div",{style:{marginBottom:"12px",display:"flex",justifyContent:a.userId===e?.uid?"flex-end":"flex-start"},children:t.jsxs("div",{style:{maxWidth:"80%",padding:"8px 12px",borderRadius:"8px",backgroundColor:a.userId===e?.uid?"#1890ff":"#f5f5f5",color:a.userId===e?.uid?"#fff":"#000"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px"},children:[t.jsx($,{size:"small",icon:t.jsx(Q,{})}),t.jsx(S,{style:{fontSize:"12px",color:a.userId===e?.uid?"rgba(255,255,255,0.8)":"rgba(0,0,0,0.6)"},children:a.userEmail.split("@")[0]}),t.jsx(S,{style:{fontSize:"11px",color:a.userId===e?.uid?"rgba(255,255,255,0.6)":"rgba(0,0,0,0.4)"},children:new Date(a.timestamp).toLocaleTimeString()}),a.userId===e?.uid&&t.jsx(I,{type:"text",size:"small",icon:t.jsx(X,{}),onClick:()=>f(a.id),style:{color:"rgba(255,255,255,0.8)",minWidth:"auto",padding:"0 4px"}})]}),t.jsx("div",{children:a.text})]})},a.id)),t.jsx("div",{ref:w})]}),t.jsxs(Z.Compact,{style:{width:"100%"},children:[t.jsx(ee,{value:l,onChange:a=>{n(a.target.value)},placeholder:"Type a message...",onPressEnter:b}),t.jsx(I,{type:"primary",icon:t.jsx(se,{}),onClick:b,disabled:!l.trim(),children:"Send"})]})]})}const{Title:ce,Text:le}=P;function xe(){const{teamId:s}=O(),r=V(),e=T(b=>b.auth.user),[u,o]=c.useState(null),[l,n]=c.useState([]),[d,m]=c.useState(0),[x,w]=c.useState(!1);return c.useEffect(()=>{},[s]),c.useEffect(()=>{if(!s)return;(async()=>{try{const f=await re.getTeamById(s);o(f);const a=[];f?.coachId&&a.push(f.coachId),f?.userId&&a.push(f.userId);const i=await M(j(y,`teams/${s}`));if(i.exists()){const A=(i.val()||{}).members||{};Object.keys(A).forEach(C=>{a.includes(C)||a.push(C)})}const g=await M(j(y,"users")),h=g.exists()?g.val():{},v=a.map(p=>({uid:p,...h[p]||{}}));n(v);const _=v.filter(p=>p.online||!1).length;m(_);const z=v.some(p=>p.uid===e?.uid)||f?.userId===e?.uid||f?.coachId===e?.uid,q=h[e?.uid||""]?.role==="admin"||h[e?.uid||""]?.role==="owner";w(!!(z||q))}catch(f){console.error("Failed to load team info:",f)}})()},[s,e?.uid]),t.jsxs("div",{className:"page-container",children:[t.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[t.jsx($,{size:48,icon:t.jsx(te,{})}),t.jsxs("div",{children:[t.jsx(ce,{level:2,style:{margin:0},children:u?.name||`Team ${s}`}),t.jsxs(le,{type:"secondary",children:[d," online â€¢ ",l.length," members"]})]})]}),t.jsx("div",{children:t.jsx(I,{onClick:()=>r("/admin/teams"),children:"Back to Teams"})})]}),t.jsx(ae,{children:t.jsx(ie,{teamId:s,canPost:x})})]})}export{xe as default};
