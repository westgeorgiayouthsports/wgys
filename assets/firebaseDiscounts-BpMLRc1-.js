import{n as p,o as l,q as g}from"./vendor-firebase-BzUsRx-X.js";import{e as u,l as s,q as w,A as h}from"./index-lWfxYzVq.js";import{s as b}from"./firebaseSeasons-BgcPTcUq.js";import{s as D}from"./slugify-IzZIKjBC.js";const I={normalizePayload(o){if(!o)return{};const t={...o||{}};if(t.allowedProgramTemplateIds&&typeof t.allowedProgramTemplateIds=="string"&&(t.allowedProgramTemplateIds=t.allowedProgramTemplateIds.split(",").map(e=>e.trim()).filter(Boolean)),t.code!==void 0&&t.code!==null&&(t.code=String(t.code).trim().toUpperCase()),t.amount!==void 0&&t.amount!==null&&(t.amount=Number(t.amount)),t.active!==void 0&&t.active!==null)if(typeof t.active=="string"){const e=t.active.trim().toLowerCase();t.active=e==="true"||e==="1"}else typeof t.active=="number"?t.active=t.active!==0:t.active=!!t.active;return t.perAdditionalAmounts&&(typeof t.perAdditionalAmounts=="string"?t.perAdditionalAmounts=t.perAdditionalAmounts.split(",").map(e=>Number(e.trim())).filter(e=>!Number.isNaN(e)):Array.isArray(t.perAdditionalAmounts)&&(t.perAdditionalAmounts=t.perAdditionalAmounts.map(e=>Number(e)))),t.amountType||(t.amountType="fixed"),(t.active===void 0||t.active===null)&&(t.active=!1),t},async getDiscounts(){try{const o=await p(l(u,"discounts"));if(!o.exists())return[];const t=o.val();return Object.entries(t).map(([e,i])=>({id:e,...i||{}}))}catch(o){return s.error("Error fetching discounts:",o),[]}},async getDiscountById(o){try{const t=await p(l(u,`discounts/${o}`));return t.exists()?{id:o,...t.val()||{}}:null}catch(t){return s.error("Error fetching discount by id",t),null}},async findByCode(o,t){try{const e=await this.getDiscounts(),i=(o||"").trim().toLowerCase();if(!i)return null;if(t)try{const f=(await this.getActiveDiscountsForSeason(t)).find(c=>(c.code||"").toLowerCase()===i);if(f)return f}catch(n){s.error("Failed to read season merged discounts, falling back",n)}const a=e.filter(n=>(n.code||"").toLowerCase()===i&&(n.active??!1));if(a.length===0)return null;if(!t)return a[0]||null;const r=await b.getSeasonById(t);for(const n of a)if(r&&Array.isArray(r.discountIds)&&r.discountIds.includes(n.id))return n;return null}catch(e){return s.error("Error finding discount by code",e),null}},async getGroupDiscounts(){try{const o=await p(l(u,"groupDiscounts"));return o.exists()?o.val()||{}:{}}catch(o){return s.error("Error fetching groupDiscounts",o),{}}},async getGroupDiscountsForSeason(o){try{const t=await p(l(u,`groupDiscounts/${o}`));return t.exists()&&t.val()||null}catch(t){return s.error("Error fetching groupDiscounts for season",t),null}},async getSeasonDiscountConfigs(o){try{const t=await p(l(u,`seasons/${o}/discounts`));return t.exists()&&t.val()||null}catch(t){return s.error("Error fetching season discount configs",t),null}},async getActiveDiscountsForSeason(o){try{const t=await this.getSeasonDiscountConfigs(o);if(!t)return[];const e=Object.keys(t);if(e.length===0)return[];const i=[],a=new Date;for(const r of e){const n=t[r]||{},f=n.discountId||r,c=await this.getDiscountById(f);if(!c)continue;const d={...c};n.active!==void 0&&(d.active=!!n.active);const m=n.startDate?new Date(n.startDate):null,y=n.expirationDate?new Date(n.expirationDate):null;n.amount!==void 0&&n.amount!==null&&(d.amount=Number(n.amount)),n.amountType&&(d.amountType=n.amountType),d.seasonId=o,d.active&&(m&&m>a||y&&y<a||i.push(d))}return i}catch(t){return s.error("Error building active discounts for season",t),[]}},async cloneSeasonDiscounts(o,t){try{const e=await p(l(u,`seasons/${o}/discounts`)),i=e.exists()?e.val():null;await g(l(u,`seasons/${t}/discounts`),i||null)}catch(e){throw s.error("Error cloning season discounts",e),e}},async setSeasonDiscountConfig(o,t,e){try{const i=["discountId","active","expirationDate","startDate","amount","amountType"],a=Object.fromEntries(Object.entries(e||{}).filter(([r,n])=>i.includes(r)&&n!==void 0));await g(l(u,`seasons/${o}/discounts/${t}`),a);try{await w.log({action:"season.discount.set",entityType:h.Season,entityId:o,details:{key:t,cfg:a}})}catch(r){s.error("Error auditing season.discount.set",r)}}catch(i){throw s.error("Error setting season discount config",i),i}},async removeSeasonDiscountConfig(o,t){try{const e=l(u,`seasons/${o}/discounts/${t}`),i=await p(e),a=i.exists()?i.val():null;await g(e,null);try{await w.log({action:"season.discount.removed",entityType:h.Season,entityId:o,details:{key:t,before:a}})}catch(r){s.error("Error auditing season.discount.removed",r)}}catch(e){throw s.error("Error removing season discount config",e),e}},async createDiscount(o){try{const t=this.normalizePayload(o);console.debug("firebaseDiscounts.createDiscount payload:",t),t.scope&&delete t.scope,t.year&&delete t.year,t.startDate&&delete t.startDate,t.endDate&&delete t.endDate;let i=t.id||(t.code?D(String(t.code)):null)||`discount_${Date.now()}`;try{const r=await p(l(u,"discounts")),n=r.exists()?r.val():{},f=Object.entries(n);if(t.code){const d=String(t.code).trim().toLowerCase();if(f.find(([,y])=>String(y.code||"").trim().toLowerCase()===d))throw new Error("A discount with that code already exists")}if(f.find(([d])=>d===i)){let d=1;for(;f.find(([m])=>m===`${i}-${d}`);)d+=1;i=`${i}-${d}`}}catch(r){if(r.message==="A discount with that code already exists")throw r;s.error("Error checking duplicate discounts",r)}try{const r=(t.code||"").toString().trim().toLowerCase(),n=(i||"").toString().trim().toLowerCase();r==="sibling"||n==="sibling"?(t.amountType="fixed",t.appliesTo="line_item",t.perAdditional=!0,(!Array.isArray(t.perAdditionalAmounts)||t.perAdditionalAmounts.length===0)&&(t.perAdditionalAmounts=[10,10,10]),(t.amount===void 0||t.amount===null)&&(t.amount=0)):(t.perAdditional=!1,t.perAdditionalAmounts&&delete t.perAdditionalAmounts)}catch(r){s.error("Error applying sibling defaults",r)}const a={...t};a.id!==void 0&&delete a.id,Object.keys(a).forEach(r=>{a[r]===void 0&&delete a[r]}),await g(l(u,`discounts/${i}`),a);try{await w.log({action:"discount.created",entityType:h.Discount,entityId:i,details:a})}catch(r){s.error("Error auditing discount.created",r)}return i}catch(t){throw s.error("Error creating discount",t),t}},async updateDiscount(o,t){try{const e=this.normalizePayload(t);console.debug("firebaseDiscounts.updateDiscount id:",o,"payload:",e),e.scope&&delete e.scope,e.year&&delete e.year,e.startDate&&delete e.startDate,e.endDate&&delete e.endDate;const i={...e};if(Object.keys(i).forEach(c=>{i[c]===void 0&&delete i[c]}),e.code){try{(e.code||"").toString().trim().toLowerCase()==="sibling"?(e.amountType="fixed",e.appliesTo="line_item",e.perAdditional=!0,(!Array.isArray(e.perAdditionalAmounts)||e.perAdditionalAmounts.length===0)&&(e.perAdditionalAmounts=[10,10,10]),(e.amount===void 0||e.amount===null)&&(e.amount=0)):(e.perAdditional=!1,e.perAdditionalAmounts&&delete e.perAdditionalAmounts)}catch(c){s.error("Error applying sibling defaults on update",c)}try{const c=await p(l(u,"discounts")),d=c.exists()?c.val():{},m=Object.entries(d),y=String(e.code).trim().toLowerCase();if(m.find(([v,A])=>v!==o&&String(A.code||"").trim().toLowerCase()===y))throw new Error("A discount with that code already exists")}catch(c){if(c.message==="A discount with that code already exists")throw c;s.error("Error checking duplicate discount code on update",c)}}const a=l(u,`discounts/${o}`),r=await p(a),n=r.exists()?r.val()||{}:{};n.id!==void 0&&delete n.id;const f={...n,...i};i.active===void 0&&typeof n.active=="boolean"&&(f.active=n.active),f.id!==void 0&&delete f.id,await g(a,f);try{await w.log({action:"discount.updated",entityType:h.Discount,entityId:o,details:{before:n,after:i}})}catch(c){s.error("Error auditing discount.updated",c)}}catch(e){throw s.error("Error updating discount",e),e}},async deleteDiscount(o){try{const t=l(u,`discounts/${o}`),e=await p(t),i=e.exists()?e.val():null;await g(t,null);try{await w.logDelete(h.Discount,o,i)}catch(a){s.error("Error auditing discount.deleted",a)}}catch(t){throw s.error("Error deleting discount",t),t}},async ensureDefaultGlobalDiscounts(){try{const o=await p(l(u,"discounts")),t=o.exists()?o.val():{},e={sibling:{code:"SIBLING",amountType:"fixed",amount:0,appliesTo:"line_item",perAdditional:!0,perAdditionalAmounts:[10,10,10],minRegistrationsPerFamily:2,allowedProgramTemplateIds:["baseball-recreation","softball-recreation"],active:!0,description:"Sibling discount for rec programs only"},earlybird:{code:"EARLYBIRD",amountType:"fixed",amount:15,appliesTo:"line_item",allowedProgramTemplateIds:["baseball-recreation","softball-recreation"],active:!0,description:"Early registration discount for rec programs"},blackfriday:{code:"BLACKFRIDAY",amountType:"fixed",amount:25,appliesTo:"line_item",allowedProgramTemplateIds:["baseball-recreation","softball-recreation"],active:!0,description:"Black Friday promotional discount"},cybermonday:{code:"CYBERMONDAY",amountType:"fixed",amount:20,appliesTo:"line_item",allowedProgramTemplateIds:["baseball-recreation","softball-recreation"],active:!0,description:"Cyber Monday promotional discount"}},i=[];for(const[a,r]of Object.entries(e))(!t||!t[a])&&(await this.createDiscount({id:a,...r}),i.push(a));return i}catch(o){throw s.error("Error ensuring default global discounts",o),o}}};export{I as f};
