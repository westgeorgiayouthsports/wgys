import{J as F,l as w,j as t,K as $,D as V,q as M,A as q}from"./index-lWfxYzVq.js";import{a as U,u as W}from"./vendor-redux-BbD-gcRX.js";import{p as X}from"./firebaseProgramRegistrations-CcV5GOOA.js";import{s as O}from"./firebaseSeasons-BgcPTcUq.js";import{f as j}from"./firebaseDiscounts-BpMLRc1-.js";import{p as Z}from"./paymentPlans-v28zbRiz.js";import{u as ee,r as m}from"./vendor-router-Ck4ZuSP9.js";import{aG as te,aH as k,x as se,B as S,N as oe,d as D,S as ne,ag as ae,Q as y}from"./vendor-antd-CieyQibU.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-firebase-BzUsRx-X.js";import"./season-CjhZh6iC.js";import"./firebasePrograms-DQfL_YhU.js";import"./slugify-IzZIKjBC.js";import"./firebaseTeams-DYGNnM-E.js";const{Text:u,Title:re}=se;function ve({open:G,onClose:E}){const d=U(e=>e.cart.items),C=W(),R=ee(),[N,_]=m.useState({}),[P,z]=m.useState(""),[h,J]=m.useState(null),[g,B]=m.useState(()=>({groupTotal:0,codeTotal:0})),[T,A]=m.useState([]),[I,v]=m.useState("full");m.useEffect(()=>{const e={};d.forEach(o=>{e[o.id]=o.paymentPlan||F.full}),_(e),(async()=>{try{const o=Array.from(new Set(d.map(n=>n.programSeasonId).filter(Boolean))),r=[],l=await Z.getPaymentPlans();for(const n of o){const c=d.filter(i=>i.programSeasonId===n),s=await O.getSeasonById(n);for(const i of l||[]){if(i.active===!1)continue;const a=!i.seasonId||i.seasonId===n,p=!i.programIds||i.programIds.length===0||c.some(f=>(i.programIds||[]).includes(f.programId));a&&p&&r.push({...i,seasonId:n,seasonName:s?s.name:void 0})}}A(r),r.length>0?v(r[0].id):v("full")}catch(o){console.error("Error loading season payment plans",o),A([]),v("full")}})()},[d]),m.useEffect(()=>{(async()=>{try{let e=null;try{e=await j.getGroupDiscounts()}catch(n){w.error("Error fetching global group discounts",n),e=null}const o={};for(const n of d){const c=n.programSeasonId||"no-season";o[c]=o[c]||[],o[c].push(n)}let r=0;for(const n of Object.keys(o)){if(n==="no-season")continue;let c={};if(e)c=e[n]||{};else if(j&&j.getGroupDiscountsForSeason)try{c=await j.getGroupDiscountsForSeason(n)||{}}catch(a){w.error("Error fetching group discounts for season",a),c={}}else{const a=await O.getSeasonById(n);if(!a)continue;c=a.groupDiscounts||{}}if(!c||Object.keys(c).length===0)continue;const s=o[n].slice().sort((a,p)=>a.price-p.price),i=Object.keys(c).map(a=>parseInt(a,10)).sort((a,p)=>a-p);for(const a of i)if(s.length>=a){const p=c[a]||0,f=a-1,x=s[f];if(x){const K=Math.min(p,x.price*(x.quantity||1));r+=K}}}let l=0;if(h){const n=h.seasonId,s=d.filter(p=>(p.programSeasonId||"no-season")===n).reduce((p,f)=>p+f.price*(f.quantity||1),0),i=h.type||"fixed",a=h.amount||0;i==="fixed"?l=Math.min(a,s):l=Math.round(a/100*s)}B({groupTotal:r,codeTotal:l})}catch(e){console.error("Error computing discounts",e),B({groupTotal:0,codeTotal:0})}})()},[d,N,h]);const b=d.reduce((e,o)=>e+o.price*(o.quantity||1),0),L=()=>{C($()),y.success("Cart emptied")},Q=e=>{C(V(e))},Y=async()=>{if(d.length===0){y.info("Your cart is empty");return}try{const e=b,o={group:g.groupTotal,code:g.codeTotal},r=Math.max(0,e-o.group-o.code);let l=null;I&&I!=="full"&&(l=T.find(s=>s.id===I)||null);let n={type:"full",initial:r,installments:[]};if(l){const s=l.initialAmount??0,i=Math.max(0,r-s),a=l.installments||0,p=a>0?+(i/a).toFixed(2):0;n={type:"plan",planId:l.id,planName:l.name,seasonId:l.seasonId,initial:+s.toFixed(2),installments:Array.from({length:a}).map((f,x)=>({installmentNumber:x+1,amount:p,dueDay:l.paymentDay||1}))}}const c={amount:Math.round(r*100),currency:"usd",items:d.map(s=>({programId:s.programId,programName:s.programName,athleteId:s.athleteId,price:s.price,quantity:s.quantity})),discounts:o,appliedCode:h,paymentSchedule:n};try{const s=await fetch("/api/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(s.ok){const i=await s.json();if(await M.log({action:"cart.checkout.initiated",entityType:q.Cart,details:{items:d,discounts:o,finalAmount:r,session:i}}),i.url){window.location.href=i.url;return}}}catch(s){console.warn("Stripe checkout endpoint not available, falling back to pending registrations",s)}for(const s of d){const i=N[s.id]||s.paymentPlan||F.full;await X.createProgramRegistration(s.programId,"cart_checkout",s.responses||[],s.price,"cart",s.athleteId||void 0,void 0,i,{programName:s.programName})}await M.log({action:"cart.checkout.completed",entityType:q.Cart,details:{items:d,discounts:o,finalAmount:r}}),C($()),y.success("Checkout complete — registrations created (pending payment)"),E(),R("/my-registrations")}catch(e){console.error("Checkout failed",e),y.error("Checkout failed")}},H=async()=>{if(!P){y.info("Enter a discount code");return}try{const e=Array.from(new Set(d.map(o=>o.programSeasonId).filter(Boolean)));for(const o of e){let r=null;try{r=await j.findByCode(P.trim(),o)}catch(c){w.error("Error looking up discount code via service",c),r=null}if(!r)continue;const l=r.amountType||r.type||"fixed",n=r.amount??0;J({seasonId:o,code:r.code,type:l,amount:n}),y.success("Discount code applied");return}y.error("Discount code not found for items in your cart")}catch(e){console.error("Error applying discount code",e),y.error("Error applying discount code")}};return t.jsxs(te,{title:t.jsx(re,{level:4,style:{margin:0},children:"Shopping Cart"}),placement:"right",size:420,open:G,onClose:E,closable:!0,maskClosable:!0,keyboard:!0,zIndex:10010,children:[t.jsx(k,{dataSource:d,renderItem:e=>t.jsxs(k.Item,{actions:[t.jsx(S,{danger:!0,onClick:()=>Q(e.id),children:"Remove"})],children:[t.jsx(k.Item.Meta,{title:t.jsx(u,{strong:!0,children:e.programName}),description:t.jsxs("div",{children:[t.jsx("div",{children:t.jsxs(u,{children:["Athlete: ",e.athleteName||e.athleteId||"—"]})}),t.jsxs("div",{style:{marginTop:6},children:["Qty: ",e.quantity]})]})}),t.jsx("div",{children:t.jsxs(u,{strong:!0,children:["$",(e.price*(e.quantity||1)).toFixed(2)]})})]})}),t.jsx(oe,{}),t.jsxs("div",{style:{marginBottom:12},children:[t.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[t.jsx("input",{value:P,onChange:e=>z(e.target.value),placeholder:"Discount code",style:{flex:1,padding:"8px 10px",borderRadius:4,border:"1px solid #ccc"}}),t.jsx(S,{onClick:H,children:"Apply"})]}),t.jsxs("div",{style:{marginBottom:12},children:[t.jsx(u,{strong:!0,children:"Payment Plan"}),t.jsx("div",{style:{marginTop:8},children:T.length===0?t.jsx("div",{children:t.jsx(u,{children:"Pay in full only"})}):t.jsxs(D,{value:I,onChange:e=>v(e),style:{width:"100%"},children:[t.jsx(D.Option,{value:"full",children:"Pay in Full"}),T.map(e=>t.jsxs(D.Option,{value:e.id,children:[`${e.seasonName?e.seasonName+" - ":""}${e.name}`," — $",e.initialAmount??0," upfront, ",e.installments||0," installments"]},`${e.seasonId}_${e.id}`))]})})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:6},children:[t.jsx(u,{children:"Subtotal"}),t.jsxs(u,{children:["$",b.toFixed(2)]})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:6},children:[t.jsx(u,{children:"Group discounts"}),t.jsxs(u,{children:["-$",g.groupTotal.toFixed(2)]})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:6},children:[t.jsx(u,{children:"Code discount"}),t.jsxs(u,{children:["-$",g.codeTotal.toFixed(2)]})]}),t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:12},children:[t.jsx(u,{strong:!0,children:"Total"}),t.jsxs(u,{strong:!0,children:["$",Math.max(0,b-g.groupTotal-g.codeTotal).toFixed(2)]})]}),t.jsxs(ne,{style:{width:"100%",justifyContent:"space-between"},children:[t.jsx(ae,{title:"Empty cart?",onConfirm:L,okText:"Yes",cancelText:"No",children:t.jsx(S,{danger:!0,children:"Empty Cart"})}),t.jsx(S,{type:"primary",onClick:Y,children:"Finish & Pay"})]})]})]})}export{ve as default};
