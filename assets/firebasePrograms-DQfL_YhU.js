import{n as g,o as c,z as h,x as y,q as T,t as b,A as E,B as I,N as x}from"./vendor-firebase-BzUsRx-X.js";import{l as s,e as p,q as d,A as u}from"./index-lWfxYzVq.js";import{s as P}from"./slugify-IzZIKjBC.js";const A={async getTemplates(){try{const r=await g(c(p,"programTemplates"));if(!r.exists())return[];const e=r.val();return Object.entries(e).map(([t,a])=>({id:t,...a||{}}))}catch(r){return s.error("Error fetching program templates",r),[]}},async getTemplateById(r){try{const e=await g(c(p,`programTemplates/${r}`));return e.exists()?{id:r,...e.val()||{}}:null}catch(e){throw s.error("Error fetching program template",e),e}},async createTemplate(r,e){try{const t=new Date().toISOString(),a=P(`${r.sportId||"template"}-${r.programType||"template"}`);let o=a,i=0;for(;(await g(c(p,`programTemplates/${o}`))).exists();)i+=1,o=`${a}-${i}`;const n={...r,createdAt:t,updatedAt:t};await T(c(p,`programTemplates/${o}`),n);try{await d.log({action:"programTemplate.created",entityType:u.ProgramTemplate,entityId:o,details:n})}catch(l){s.error("Error auditing programTemplate.create",l)}return o}catch(t){throw s.error("Error creating program template",t),t}},async updateTemplate(r,e,t){try{const a={...e,updatedAt:new Date().toISOString()};await y(c(p,`programTemplates/${r}`),a);try{await d.log({action:"programTemplate.updated",entityType:u.ProgramTemplate,entityId:r,details:e})}catch(o){s.error("Error auditing programTemplate.update",o)}}catch(a){throw s.error("Error updating program template",a),a}},async deleteTemplate(r,e){try{const t=await g(c(p,`programTemplates/${r}`)),a=t.exists()?t.val():null;await h(c(p,`programTemplates/${r}`));try{await d.logDelete(u.ProgramTemplate,r,a,e)}catch(o){s.error("Error auditing programTemplate.delete",o)}}catch(t){throw s.error("Error deleting program template",t),t}},async ensureDefaultProgramTemplates(){try{const r=await this.getTemplates(),e=[],t=[{sportId:"baseball",programType:"recreation",defaultBaseFee:200,sex:"any",defaultMinAge:3,defaultMaxAge:18,active:!0},{sportId:"softball",programType:"recreation",defaultBaseFee:200,sex:"female",defaultMinAge:3,defaultMaxAge:18,active:!0},{sportId:"baseball",programType:"select",defaultBaseFee:200,sex:"any",defaultMinAge:5,defaultMaxAge:18,active:!0},{sportId:"softball",programType:"select",defaultBaseFee:200,sex:"female",defaultMinAge:5,defaultMaxAge:18,active:!0}];for(const a of t)if(!r.find(i=>i.sportId===a.sportId&&i.programType===a.programType)){const i=await this.createTemplate(a);e.push(i)}return e}catch(r){throw s.error("Error ensuring default program templates",r),r}}},$={async getPrograms(){try{const r=c(p,"programs"),e=await g(r);if(!e.exists())return[];const t=e.val();return Object.entries(t).map(([a,o])=>({id:a,...o}))}catch(r){throw s.error("Error fetching programs:",r),r}},async getProgramsBySeason(r){try{const e=c(p,"programs"),t=E(e,I("seasonId"),x(r)),a=await g(t);if(!a.exists())return[];const o=a.val();return Object.entries(o).map(([i,n])=>({id:i,...n}))}catch(e){throw s.error("Error fetching programs by season:",e),e}},async createProgram(r,e){try{const t=c(p,"programs"),a=new Date().toISOString();if(!r.templateId)throw new Error("templateId is required to create a program");if(!r.seasonId)throw new Error("seasonId is required to create a program");let o={};try{const m=await A.getTemplateById(r.templateId);m&&(o=m)}catch(m){s.error("Failed to load program template for defaults",m)}const i=Object.fromEntries(Object.entries(r).filter(([m,w])=>w!==void 0&&w!=="")),n={...o,...i};o.defaultBaseFee!==void 0&&(n.basePrice===void 0||n.basePrice===null)&&(n.basePrice=o.defaultBaseFee),o.sex&&!n.sexRestriction&&(n.sexRestriction=o.sex);const l={...n,registrationOpen:!0,currentParticipants:0,totalPayments:0,createdAt:a,updatedAt:a,createdBy:e},f=await b(t,l);try{await d.log({action:"program.created",entityType:u.Program,entityId:f.key,details:l})}catch(m){s.error("Error auditing program.create",m)}return f.key}catch(t){throw s.error("Error creating program:",t),t}},async updateProgram(r,e){try{const t=c(p,`programs/${r}`),o={...Object.fromEntries(Object.entries(e).filter(([i,n])=>n!==void 0&&n!=="")),updatedAt:new Date().toISOString()};await y(t,o)}catch(t){throw s.error("Error updating program:",t),t}},async deleteProgram(r){try{const e=c(p,`programs/${r}`),t=await g(e),a=t.exists()?t.val():null;await h(e);try{await d.logDelete(u.Program,r,a)}catch(o){s.error("Error auditing program.delete:",o)}}catch(e){throw s.error("Error deleting program:",e),e}},async unlinkProgram(r){try{const e=c(p,`programs/${r}`),t=new Date().toISOString();await y(e,{seasonId:null,updatedAt:t});try{await d.log({action:"program.unlinked_from_season",entityType:u.Program,entityId:r,details:{seasonId:null}})}catch(a){s.error("Error auditing program.unlinked_from_season",a)}}catch(e){throw s.error("Error unlinking program",e),e}},async bulkUpdatePrograms(r,e){try{const t=new Date().toISOString();for(const a of r){const o=c(p,`programs/${a}`),i=Object.fromEntries(Object.entries(e).filter(([n,l])=>l!==void 0&&l!==""));await y(o,{...i,updatedAt:t})}try{await d.log({action:"program.bulk_update",entityType:u.Program,entityId:r.join(","),details:{programIds:r,updates:e}})}catch(a){s.error("Error auditing program.bulk_update:",a)}}catch(t){throw s.error("Error bulk updating programs:",t),t}}};export{A as a,$ as p};
