import{j as r,C as ee,D as te}from"./index-lWfxYzVq.js";import{u as re,r as v}from"./vendor-router-Ck4ZuSP9.js";import{G as M,t as se,S as ne,x as oe,a8 as y,B as T,a0 as ae,d as k,I as C,ad as ie,as as O,aC as B,Q as g,aD as le,C as de,M as ce}from"./vendor-antd-CieyQibU.js";import{c as ue,s as P}from"./storageService-BGD7Twul.js";import{u as me}from"./vendor-redux-BbD-gcRX.js";import{s as he}from"./firebaseSeasons-BgcPTcUq.js";const{Title:K,Text:x}=oe;function ve(L){const{program:i,athleteId:F,onClose:D,isPreview:j,familyMembers:h=[],parentInfo:b,defaultPaymentMethodId:z}=L,R=me(),[p]=M.useForm(),{token:m}=se.useToken(),W=re(),[f,_]=v.useState(F||null),[H,N]=v.useState(null),[Y,w]=v.useState({}),I=v.useRef({}),[X,q]=v.useState(!0),G=e=>{try{for(const o of i.questions||[]){const s=`q_${o.id}`,t=e[s];if(o.required){if(o.type==="checkboxes"){if(!Array.isArray(t)||t.length===0)return!1}else if(o.type==="file_upload"){if(!t||!(t.fileUrl||t.storagePath||t.name))return!1}else if(o.type==="waiver"){if(t!==!0)return!1}else if(o.type==="numeric"){if(t==null||String(t).trim()==="")return!1;const n=Number(t);if(!Number.isInteger(n)||n<0||n>2147483647)return!1}else if(o.type==="jersey_number"){if(t==null||String(t).trim()==="")return!1;const n=String(t).trim();if(!/^\d{1,2}$/.test(n))return!1;const l=Number(n);if(!Number.isInteger(l)||l<0||l>99)return!1}else if(t==null||String(t).trim()==="")return!1}else if(t!=null&&String(t).trim()!==""){if(o.type==="numeric"){const n=Number(t);if(!Number.isInteger(n)||n<0||n>2147483647)return!1}if(o.type==="jersey_number"){const n=String(t).trim();if(!/^\d{1,2}$/.test(n))return!1;const l=Number(n);if(!Number.isInteger(l)||l<0||l>99)return!1}}}return!0}catch{return!1}},U=()=>{const e=y(),o=e.month()>=7,s=i.season?.year||i.year||(o?e.year()+1:e.year()),n=(i.sport||"baseball")==="softball"?0:4;return y().year(s).month(n).date(1)};v.useEffect(()=>{F&&_(F),b&&p.setFieldsValue({parentName:b.name,parentEmail:b.email,phone:b.phone}),j&&(!f||f===null)&&h&&h.length>0&&_(h[0].id),(async()=>{try{const s=i.seasonId||i.season||null;if(s){const t=await he.getSeasonById(s);N(t?t.name:null)}else N(null)}catch{N(null)}})();const e=p.getFieldsValue(),o=p.getFieldsError().some(s=>s.errors&&s.errors.length>0);q(!o&&G(e))},[F,b,p]);const V=e=>{const o=p.getFieldsError().some(s=>s.errors&&s.errors.length>0);q(!o&&G(e))},Q=async e=>{const o=`${Date.now()}-${Math.floor(Math.random()*1e5)}`,s=i.basePrice||0,t=h.find(d=>d.id===f),n=[],l=Object.keys(e).filter(d=>d.startsWith("q_"));for(const d of l){const a=e[d];if(a instanceof File)try{const u=`uploads/${Date.now()}_${a.name}`,{url:S,path:A}=await P.uploadFileWithProgress(u,a,E=>{w($=>({...$,[d]:E}))});n.push({questionId:d.replace("q_",""),answer:a.name,fileUrl:S,storagePath:A})}catch(u){console.error("File upload failed",u),n.push({questionId:d.replace("q_",""),answer:a.name})}else if(Array.isArray(a))n.push({questionId:d.replace("q_",""),answer:a});else if(a&&a.file){const u=a.file.originFileObj||a.file;if(u instanceof File)try{const S=`uploads/${Date.now()}_${u.name}`,{url:A,path:E}=await P.uploadFileWithProgress(S,u,$=>{w(Z=>({...Z,[d]:$}))});n.push({questionId:d.replace("q_",""),answer:u.name,fileUrl:A,storagePath:E})}catch(S){console.error("File upload failed",S),n.push({questionId:d.replace("q_",""),answer:u.name})}else n.push({questionId:d.replace("q_",""),answer:String(a)})}else a&&a.fileUrl&&a.storagePath?n.push({questionId:d.replace("q_",""),answer:a.name||a.fileName||"file",fileUrl:a.fileUrl,storagePath:a.storagePath}):n.push({questionId:d.replace("q_",""),answer:a})}const c={id:o,programId:i.id,programName:i.name,programSeasonId:i.seasonId||i.season||null,athleteId:f,athleteName:t?`${t.firstName||""} ${t.lastName||""}`.trim():null,price:s,quantity:1,responses:n,preview:!!j};try{R(ee(c)),g.success(j?"Preview item added to cart (dummy)":"Added to cart"),c.preview&&setTimeout(async()=>{try{const d=(n||[]).map(a=>a.storagePath).filter(Boolean);for(const a of d)try{await P.deleteFile(a)}catch(u){console.error("Failed to delete preview file",u)}R(te(o)),g.info("Preview item removed from cart and uploaded files deleted")}catch(d){console.error("Failed to remove preview item",d)}},8e3),D&&D()}catch(d){console.error("Add to cart failed",d)}},J=()=>{ce.confirm({title:"Cancel registration",content:"Are you sure you want to cancel? All entered information will be discarded.",okText:"Yes, discard",okType:"danger",cancelText:"Keep editing",onOk:async()=>{try{const e=Object.values(I.current).flat();for(const o of e)try{await P.deleteFile(o)}catch(s){console.error("Failed to delete uploaded file on cancel",s)}}catch(e){console.error("Error cleaning uploads on cancel",e)}p.resetFields(),I.current={},w({}),D&&D(),g.info("Registration discarded")}})};return r.jsx("div",{style:{padding:24,minHeight:"100vh",background:m.colorBgElevated},children:r.jsxs("div",{style:{maxWidth:900,margin:"0 auto",position:"relative"},children:[r.jsxs(ne,{style:{width:"100%",justifyContent:"space-between",marginBottom:18},children:[r.jsxs("div",{children:[r.jsx(K,{level:2,style:{margin:0,color:m.colorText},children:i.name}),r.jsx(x,{type:"secondary",children:i.description}),r.jsxs("div",{style:{marginTop:8,fontSize:13,color:m.colorTextSecondary},children:[r.jsxs("div",{children:["Season: ",H||i.season?.name||i.seasonId||"—"]}),r.jsxs("div",{children:["Birth Date Range: ",i.birthDateStart?y(i.birthDateStart).format("MMM D, YYYY"):"—"," to ",i.birthDateEnd?y(i.birthDateEnd).format("MMM D, YYYY"):"—"]}),r.jsxs("div",{children:["Grade Exemptions: ",i.allowGradeExemption?"Enabled":"Disabled"]}),i.maxGrade!==void 0&&r.jsxs("div",{children:["Max Grade: ",i.maxGrade===0?"K":i.maxGrade]})]})]}),r.jsxs("div",{style:{textAlign:"right"},children:[r.jsx("div",{style:{marginBottom:8},children:r.jsx(T,{type:"link",onClick:()=>{const e=i.sport==="softball"?"female":"male";W(`/registration-help?sex=${e}`)},children:"Registration Help"})}),i.maxParticipants&&r.jsxs("div",{style:{marginTop:8},children:[r.jsx(x,{strong:!0,children:"Limit"}),r.jsx("div",{children:r.jsxs(x,{children:[i.currentRegistrants||0," / ",i.maxParticipants]})})]}),i.private&&r.jsx("div",{style:{marginTop:8},children:r.jsx(ae,{color:"gold",children:"Invite Only"})})]})]}),r.jsxs(M,{form:p,layout:"vertical",onFinish:Q,initialValues:{paymentMethod:z||"new"},onValuesChange:(e,o)=>V(o),onFieldsChange:(e,o)=>V(o),children:[r.jsxs("div",{style:{marginBottom:16,padding:12,background:m.colorBgContainer,borderRadius:m.borderRadius},children:[r.jsx(x,{strong:!0,children:"Athlete"}),r.jsx("div",{style:{marginTop:8},children:h.length>0?j?(()=>{const e=h.find(d=>d.id===f)||h[0],o=e?.dateOfBirth,s=o?y(o).format("MMM D, YYYY"):"—",t=U();let n=null;if(o){const d=y(o);let a=t.year()-d.year();(t.month()<d.month()||t.month()===d.month()&&t.date()<d.date())&&a--,n=a}const l=e?.grade,c=ue(e?.graduationYear,t);return r.jsxs("div",{children:[r.jsxs("div",{style:{fontWeight:600},children:[e.firstName," ",e.lastName]}),r.jsxs("div",{style:{fontSize:12,color:m.colorTextSecondary},children:["DOB: ",s]}),r.jsxs("div",{style:{fontSize:12,color:m.colorTextSecondary},children:["Season Age: ",n!==null?n:"—"]}),r.jsxs("div",{style:{fontSize:12,color:m.colorTextSecondary},children:["Grade: ",l!=null?l===0?"K":l:c!==null?c===0?"K":c:"—"]})]})})():r.jsxs(r.Fragment,{children:[r.jsx(k,{value:f||void 0,onChange:e=>_(e),disabled:j,style:{width:300},children:h.filter(e=>e.roles?.includes("athlete")).map(e=>r.jsxs(k.Option,{value:e.id,children:[e.firstName," ",e.lastName]},e.id))}),f&&(()=>{const o=h.find(l=>l.id===f)?.dateOfBirth,s=o?y(o).format("MMM D, YYYY"):"—",t=U();let n=null;if(o){const l=y(o);let c=t.year()-l.year();(t.month()<l.month()||t.month()===l.month()&&t.date()<l.date())&&c--,n=c}return r.jsxs("div",{style:{marginTop:8,fontSize:12,color:m.colorTextSecondary},children:[r.jsxs("div",{children:["DOB: ",s]}),r.jsxs("div",{children:["Season Age: ",n!==null?n:"—"]})]})})()]}):r.jsx(x,{type:"secondary",children:"No athlete selected"})})]}),i.questions&&i.questions.length>0&&r.jsxs("div",{style:{marginBottom:16},children:[r.jsx(K,{level:5,children:"Additional Information"}),i.questions.sort((e,o)=>e.order-o.order).map(e=>{const o=[];return e.required&&o.push({required:!0,message:"This field is required"}),e.type==="numeric"&&o.push({validator:async(s,t)=>{if(t==null||t==="")return e.required?Promise.reject(new Error("Please enter a number")):Promise.resolve();const n=Number(t);if(!Number.isInteger(n))return Promise.reject(new Error("Value must be an integer"));const l=0,c=2147483647;return n<l||n>c?Promise.reject(new Error(`Value must be between ${l} and ${c}`)):Promise.resolve()}}),e.type==="jersey_number"&&o.push({validator:async(s,t)=>{if(t==null||t==="")return e.required?Promise.reject(new Error("Please enter a jersey number")):Promise.resolve();const n=String(t).trim();if(!/^\d{1,2}$/.test(n))return Promise.reject(new Error("Enter 0–99 (00 allowed)"));const l=Number(n);return!Number.isInteger(l)||l<0||l>99?Promise.reject(new Error("Value must be between 0 and 99")):Promise.resolve()}}),r.jsxs(M.Item,{name:`q_${e.id}`,label:e.title,rules:o,extra:e.type==="numeric"?"Enter a positive integer.":void 0,children:[e.type==="short_answer"&&r.jsx(C,{}),e.type==="paragraph"&&r.jsx(C.TextArea,{rows:3}),e.type==="numeric"&&r.jsx(ie,{style:{width:"100%"},step:1,onKeyDown:s=>{["Backspace","Tab","ArrowLeft","ArrowRight","Delete","Home","End"].includes(s.key)||s.ctrlKey||s.metaKey||/^[0-9]$/.test(s.key)||s.preventDefault()},onPaste:s=>{const t=s.clipboardData.getData("text");/^[0-9]+$/.test(t)||s.preventDefault()}}),e.type==="jersey_number"&&r.jsx(C,{maxLength:2,placeholder:"0-99 (00 allowed)",inputMode:"numeric",onKeyDown:s=>{["Backspace","Tab","ArrowLeft","ArrowRight","Delete","Home","End"].includes(s.key)||s.ctrlKey||s.metaKey||/^[0-9]$/.test(s.key)||s.preventDefault()},onPaste:s=>{const t=s.clipboardData.getData("text");/^[0-9]{1,2}$/.test(t)||s.preventDefault()}}),e.type==="dropdown"&&r.jsx(k,{options:(e.options||[]).map(s=>({label:s,value:s}))}),e.type==="checkboxes"&&r.jsx(O.Group,{options:e.options||[]}),e.type==="file_upload"&&r.jsxs("div",{children:[r.jsx(B,{beforeUpload:s=>{const t=s.name||"",n=t.toLowerCase(),l=20*1024*1024;if(n==="desktop.ini"||n===".ds_store"||t.startsWith("."))return g.error("Hidden or unsupported file. Upload skipped."),B.LIST_IGNORE;if(s.size>l)return g.error("File is too large. Maximum allowed size is 20 MB."),B.LIST_IGNORE;const c=`q_${e.id}`;w(a=>({...a,[c]:0}));const d=`uploads/${Date.now()}_${s.name}`;return P.uploadFileWithProgress(d,s,a=>{w(u=>({...u,[c]:a}))}).then(({url:a,path:u})=>{p.setFieldsValue({[c]:{name:s.name,fileUrl:a,storagePath:u}}),I.current[c]=I.current[c]||[],I.current[c].push(u),g.success(`${s.name} uploaded`)}).catch(a=>{console.error("Upload failed",a),g.error("File upload failed")}),!1},showUploadList:!1,onRemove:()=>{p.setFieldsValue({[`q_${e.id}`]:void 0})},maxCount:1,children:r.jsx(T,{children:"Upload File"})}),Y[`q_${e.id}`]!==void 0&&r.jsx("div",{style:{marginTop:8},children:r.jsx(le,{percent:Y[`q_${e.id}`],size:"small"})})]}),e.type==="waiver"&&r.jsx(O,{})]},e.id)})]}),r.jsxs("div",{style:{marginTop:16,display:"flex",flexDirection:"column",gap:12},children:[r.jsxs("div",{style:{padding:12,background:m.colorBgContainer,borderRadius:m.borderRadius},children:[r.jsx(x,{strong:!0,children:"Base Amount"}),r.jsx("div",{children:r.jsxs(x,{children:["$",(i.basePrice||0).toFixed(2)]})})]}),r.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:8},children:[!j&&r.jsx(T,{htmlType:"button",onClick:J,icon:r.jsx(de,{}),children:"Cancel"}),r.jsx(T,{type:"primary",htmlType:"submit",disabled:!X,children:"Add to Cart"})]})]})]})]})})}export{ve as R};
