import{j as s}from"./index-lWfxYzVq.js";import{r as i,u as E}from"./vendor-router-Ck4ZuSP9.js";import{A as I}from"./AdminPageHeader-BidreVSQ.js";import{s as A}from"./firebaseSeasons-BgcPTcUq.js";import{f as n}from"./firebaseDiscounts-BpMLRc1-.js";import{aF as P,S as H,B as S,ax as R,H as G,az as N,d as T,a2 as $,ak as z}from"./vendor-antd-CieyQibU.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-redux-BbD-gcRX.js";import"./vendor-firebase-BzUsRx-X.js";import"./season-CjhZh6iC.js";import"./firebasePrograms-DQfL_YhU.js";import"./slugify-IzZIKjBC.js";import"./firebaseTeams-DYGNnM-E.js";function te(){const[c,y]=P.useNotification(),[w,h]=i.useState([]),[t,l]=i.useState(null),[D,C]=i.useState([]),[x,v]=i.useState({}),[b,u]=i.useState(!1),[j,f]=i.useState(!1);i.useEffect(()=>{k(),B()},[]);const k=async()=>{const e=await A.getSeasons();h(e||[]),e&&e.length&&l(e[0].id)},B=async()=>{try{const e=await n.getDiscounts();C(e||[]),f(!1)}catch(e){console.error("Error fetching discounts:",e),(e&&e.code&&e.code.includes("permission")||e&&String(e).toLowerCase().includes("permission denied"))&&f(!0),c.error({title:"Failed to load discounts"})}},d=async e=>{u(!0);try{const o=await n.getSeasonDiscountConfigs(e)||{};v(o)}catch(o){console.error(o),c.error({title:"Failed to load season discount configs"})}finally{u(!1)}};i.useEffect(()=>{t&&d(t)},[t]);const m=E(),g=window.__wgys_location__||void 0,p=g&&g.state?.from||void 0,F=async(e,o)=>{if(t)try{o?await n.setSeasonDiscountConfig(t,e,{discountId:e,active:!0}):await n.removeSeasonDiscountConfig(t,e),await d(t),c.success({title:"Season discount updated"})}catch(r){console.error(r),c.error({title:"Failed to update season discount"})}},L=async()=>{if(t)try{const e=await n.getDiscounts(),o=e.find(a=>a.id==="sibling"||(a.code||"").toLowerCase().includes("sibling")),r=e.find(a=>a.id==="earlybird"||(a.code||"").toLowerCase().includes("early"));o&&await n.setSeasonDiscountConfig(t,"sibling",{discountId:o.id,active:!0}),r&&await n.setSeasonDiscountConfig(t,"earlybird",{discountId:r.id,active:!0}),await d(t),c.success({title:"Defaults created"})}catch(e){console.error(e),c.error({title:"Failed to create defaults"})}},_=[{title:"Code",dataIndex:"code",key:"code"},{title:"Description",dataIndex:"description",key:"description"},{title:"Linked",key:"linked",render:(e,o)=>{const r=!!x[o.id];return s.jsx(z,{checked:r,onChange:a=>F(o.id,a)})}}];return s.jsxs("div",{style:{padding:24},children:[y,s.jsx(I,{title:"Season Discounts",subtitle:null,nav:s.jsx(S,{icon:s.jsx(R,{}),onClick:()=>{if(p)return m(p);m(-1)},children:"Back"}),actions:s.jsx(H,{children:s.jsx(S,{onClick:L,children:"Create Defaults"})})}),s.jsxs(G,{children:[j&&s.jsx(N,{message:"Permission denied",description:"Your account cannot read global discounts. Update RTDB rules to allow access to /discounts for authenticated/admin users or sign in with an admin account.",type:"warning",style:{marginBottom:12}}),s.jsx("div",{style:{marginBottom:12},children:s.jsx(T,{style:{width:320},value:t||void 0,onChange:e=>l(e),options:(w||[]).map(e=>({label:`${e.name} (${e.year})`,value:e.id}))})}),s.jsx($,{dataSource:D.map(e=>({...e,key:e.id})),columns:_,loading:b})]})]})}export{te as default};
