import{q as j,j as t}from"./index-lWfxYzVq.js";import{r as o}from"./vendor-router-Ck4ZuSP9.js";import{a as O}from"./vendor-redux-BbD-gcRX.js";import{B as x,H as D,S as R,I as w,d as n,a2 as $,a8 as b,T as q,ag as H,ah as P,Q as S}from"./vendor-antd-CieyQibU.js";import{A as Q}from"./AdminPageHeader-BidreVSQ.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-firebase-BzUsRx-X.js";function J(){const{role:r}=O(e=>e.auth),[A,y]=o.useState([]),[v,l]=o.useState(!1),[d,k]=o.useState(""),[c,E]=o.useState(""),[p,C]=o.useState("all"),[f,h]=o.useState([]);o.useEffect(()=>{g()},[]);const g=async()=>{l(!0);const e=await j.getLogs(1e3);y(e.sort((a,i)=>(i.timestamp||"").localeCompare(a.timestamp||""))),l(!1)},I=async e=>{if(!e)return;l(!0);const a=await j.deleteLog(e);l(!1),a?(S.success("Deleted audit entry"),y(i=>i.filter(s=>s.id!==e))):S.error("Failed to delete audit entry")},T=A.filter(e=>!(d&&!(e.action||"").toLowerCase().includes(d.toLowerCase())||c&&!((e.actorEmail||"")+(e.actorId||"")).toLowerCase().includes(c.toLowerCase())||p!=="all"&&e.entityType!==p));return r!=="admin"&&r!=="owner"?t.jsx("div",{style:{padding:40},children:"Access denied"}):t.jsxs("div",{className:"page-container",children:[t.jsx(Q,{title:"Audit Logs",actions:t.jsx(x,{onClick:g,children:"Refresh"})}),t.jsxs(D,{children:[t.jsxs(R,{style:{marginBottom:12},children:[t.jsx(w,{placeholder:"Action (e.g., program.bulk_update)",value:d,onChange:e=>k(e.target.value),style:{width:320}}),t.jsx(w,{placeholder:"Actor email or id",value:c,onChange:e=>E(e.target.value),style:{width:220}}),t.jsxs(n,{value:p,onChange:e=>C(e),style:{width:160},children:[t.jsx(n.Option,{value:"all",children:"All Entities"}),t.jsx(n.Option,{value:"program",children:"Program"}),t.jsx(n.Option,{value:"team",children:"Team"}),t.jsx(n.Option,{value:"season",children:"Season"}),t.jsx(n.Option,{value:"person",children:"Person"}),t.jsx(n.Option,{value:"family",children:"Family"}),t.jsx(n.Option,{value:"teamAssignment",children:"Team Assignment"}),t.jsx(n.Option,{value:"other",children:"Other"})]})]}),t.jsx($,{dataSource:T,loading:v,rowKey:e=>e.id||`${e.timestamp}-${e.action}`,pagination:{pageSize:25},expandable:{expandedRowRender:e=>t.jsx("pre",{style:{whiteSpace:"pre-wrap",fontSize:12,margin:0},children:JSON.stringify(e.details,null,2)}),rowExpandable:e=>!!e.details,expandedRowKeys:f,onExpand:(e,a)=>{const i=a.id||`${a.timestamp}-${a.action}`;h(s=>e?Array.from(new Set([...s,i])):s.filter(m=>m!==i))}},columns:[{title:"Time",dataIndex:"timestamp",key:"timestamp",render:e=>e?b(e).format("YYYY-MM-DD HH:mm:ss"):""},{title:"Action",dataIndex:"action",key:"action"},{title:"Entity",dataIndex:"entityType",key:"entityType"},{title:"Entity ID",dataIndex:"entityId",key:"entityId"},{title:"Actor",key:"actor",render:e=>e.actorEmail||e.actorId||""},{title:"Details",dataIndex:"details",key:"details",render:(e,a)=>{const i=typeof e=="string"?e:JSON.stringify(e,null,2),s=a.id||`${a.timestamp}-${a.action}`,m=f.includes(s);return t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[t.jsx(q,{placement:"topLeft",title:t.jsx("pre",{style:{whiteSpace:"pre-wrap",maxWidth:800,overflow:"auto",margin:0},children:i}),children:t.jsx("div",{style:{maxWidth:420,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i})}),t.jsx(x,{size:"small",type:"link",onClick:()=>{h(u=>u.includes(s)?u.filter(L=>L!==s):Array.from(new Set([...u,s])))},children:m?"Collapse":"Expand"})]})}},{title:"Actions",key:"actions",render:e=>r==="owner"?t.jsx(H,{title:"Delete this audit entry?",onConfirm:()=>I(e.id),okText:"Delete",cancelText:"Cancel",children:t.jsx(x,{danger:!0,icon:t.jsx(P,{})})}):null}]})]})]})}export{J as default};
