import{l as p,j as e}from"./index-lWfxYzVq.js";import{r as d,u as Q,R as X}from"./vendor-router-Ck4ZuSP9.js";import{f as m}from"./firebaseDiscounts-BpMLRc1-.js";import{s as b}from"./slugify-IzZIKjBC.js";import{a as Y}from"./firebasePrograms-DQfL_YhU.js";import{A as Z}from"./AdminPageHeader-BidreVSQ.js";import{aF as ee,G as l,B as f,ab as te,H as ie,a2 as se,M as ae,I as S,d as D,ak as P,ad as ne,S as $,a0 as E,af as oe,ag as le,ah as re}from"./vendor-antd-CieyQibU.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-redux-BbD-gcRX.js";import"./vendor-firebase-BzUsRx-X.js";import"./firebaseSeasons-BgcPTcUq.js";import"./season-CjhZh6iC.js";import"./firebaseTeams-DYGNnM-E.js";function Te(){const[c,B]=ee.useNotification(),[R,_]=d.useState([]),[M,k]=d.useState(!1),[o,T]=d.useState(null),[z,y]=d.useState(!1),[I,x]=d.useState(null),[H,g]=d.useState(!1),[a]=l.useForm(),[O,q]=d.useState([]),[h,C]=d.useState(!1),L=Q(),A=d.useRef(void 0),u=d.useRef(null),j=async()=>{k(!0);try{const t=await m.getDiscounts();_(t||[])}catch(t){p.error("Failed to load discounts",t),c.error({title:"Failed to load discounts"})}finally{k(!1)}};d.useEffect(()=>{j()},[]),d.useEffect(()=>{let t=!0;return(async()=>{try{const i=await Y.getTemplates();t&&q(i||[])}catch(i){p.error("Failed to load program templates",i)}})(),()=>{t=!1}},[]);const U=()=>{T(null),y(!0),x(null),g(!1),u.current&&window.clearTimeout(u.current),u.current=window.setTimeout(()=>{a.resetFields(),a.setFieldsValue({active:!0,amountType:"fixed",appliesTo:"cart",perAdditional:!1,perAdditionalAmounts:[]}),u.current=null},50)};d.useEffect(()=>()=>{A.current&&clearTimeout(A.current),u.current&&window.clearTimeout(u.current)},[]);const V=t=>{A.current&&clearTimeout(A.current),A.current=window.setTimeout(async()=>{try{const i=String((t??a.getFieldValue("code"))||"").trim();if(!i){a.setFields([{name:"code",errors:[]}]);return}const s=await m.getDiscounts(),n=i.toLowerCase();if(s.find(v=>(v.code||"").toLowerCase()===n&&(!(o&&o.id)||v.id!==o.id))){a.setFields([{name:"code",errors:["A discount with that code already exists"]}]);return}const r=b(i);x(r),s.find(v=>v.id===r&&(!(o&&o.id)||v.id!==o.id))?(a.setFields([{name:"code",errors:["Computed id from code collides with existing discount id"]}]),g(!0)):(a.setFields([{name:"code",errors:[]}]),g(!1));const N=String((t??a.getFieldValue("code"))||"").trim(),F=N.toLowerCase()==="sibling"||b(N).toLowerCase()==="sibling";F!==h&&(C(F),F?a.setFieldsValue({amountType:"fixed",appliesTo:"line_item",perAdditional:!0,perAdditionalAmounts:[10,10,10],amount:"0"}):a.setFieldsValue({perAdditional:!1,perAdditionalAmounts:[]}))}catch(i){p.error("Code duplicate check failed",i)}},300)},G=t=>{T(t),(async()=>{try{const i=await m.getDiscountById(t.id),s={...t||{},...i||{}},n={code:(s.code??"").toString().toUpperCase(),amountType:s.amountType??"fixed",amount:s.amount!==void 0&&s.amount!==null?String(s.amount):"",appliesTo:s.appliesTo??"cart",description:s.description??"",active:s.active===void 0||s.active===null?!1:!!s.active,allowedProgramTemplateIds:Array.isArray(s.allowedProgramTemplateIds)?s.allowedProgramTemplateIds:s.allowedProgramTemplateIds?String(s.allowedProgramTemplateIds).split(",").map(r=>r.trim()).filter(Boolean):[],perAdditional:s.perAdditional??!1,perAdditionalAmounts:Array.isArray(s.perAdditionalAmounts)?s.perAdditionalAmounts.map(r=>Number(r)):s.perAdditionalAmounts?String(s.perAdditionalAmounts).split(",").map(r=>Number(r.trim())).filter(r=>!Number.isNaN(r)):[]};a.resetFields(),a.setFieldsValue(n);const w=String(n.code||"").trim().toLowerCase()==="sibling"||b(String(n.code||"")).toLowerCase()==="sibling";C(w),w?a.setFieldsValue({amountType:"fixed",appliesTo:"line_item",perAdditional:!0,perAdditionalAmounts:n.perAdditionalAmounts&&n.perAdditionalAmounts.length?n.perAdditionalAmounts:[10,10,10]}):a.setFieldsValue({perAdditional:!1,perAdditionalAmounts:[]}),x(i?.id||t.id),g(!1)}catch(i){p.error("Failed loading discount for edit",i),a.setFieldsValue({...t})}})(),y(!0)},K=async t=>{try{if(p.info("Saving discount, editing:",o&&o.id,"vals:",t),o&&o.id){await m.updateDiscount(o.id,t),c.success({title:"Discount updated"});const i=await m.getDiscountById(o.id);x(i?.id||o.id),g(!1)}else{const i=await m.createDiscount(t),s=await m.getDiscountById(i);T(s),x(i),g(!1),c.success({title:"Discount created"}),await j(),a.resetFields(),y(!1),T(null),x(null),g(!1);return}await j()}catch(i){p.error("Failed to save discount",i);const s=i instanceof Error?i.message:String(i);let n="Failed to save discount";s.toLowerCase().includes("code already exists")&&(n="Duplicate code"),(s.toLowerCase().includes("id already exists")||s.toLowerCase().includes("collides"))&&(n="Duplicate id"),c.error({title:n,description:s})}},W=async t=>{if(t)try{await m.deleteDiscount(t),c.success({title:"Discount deleted"}),await j()}catch(i){p.error("Failed to delete discount",i),c.error({title:"Failed to delete discount"})}},J=[{title:"ID",dataIndex:"id",key:"id",width:180,render:t=>e.jsx("span",{style:{fontFamily:"monospace"},children:t})},{title:"Code",dataIndex:"code",key:"code"},{title:"Amount",key:"amount",render:(t,i)=>i.amountType==="percent"?`${i.amount}%`:`$${i.amount}`},{title:"Applies To",dataIndex:"appliesTo",key:"appliesTo"},{title:"Active",dataIndex:"active",key:"active",render:t=>t?e.jsx(E,{color:"green",children:"Active"}):e.jsx(E,{children:"Inactive"})},{title:"Actions",key:"actions",render:(t,i)=>e.jsxs($,{children:[e.jsx(f,{icon:e.jsx(oe,{}),onClick:()=>G(i)}),e.jsx(le,{title:"Delete this discount?",onConfirm:()=>W(i.id),children:e.jsx(f,{danger:!0,icon:e.jsx(re,{})})})]})}];return e.jsxs("div",{style:{padding:24},children:[B,e.jsx(Z,{title:"Discounts",subtitle:null,nav:e.jsx(f,{type:"link",onClick:()=>L("/admin/season-discounts"),children:"Season Links"}),actions:e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",width:"100%"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx(f,{type:"primary",icon:e.jsx(te,{}),onClick:U,children:"Create Discount"}),e.jsx(f,{onClick:async()=>{try{const t=await m.ensureDefaultGlobalDiscounts();t&&t.length?c.success({title:`Created defaults: ${t.join(", ")}`}):c.info({title:"Default discounts already present"}),await j()}catch(t){p.error("Failed to ensure default discounts",t),c.error({title:"Failed to ensure default discounts"})}},children:"Ensure Defaults"}),e.jsx(f,{onClick:()=>L("/admin/season-discounts"),children:"Manage Season Links"})]}),e.jsx("div",{style:{marginLeft:"auto",paddingLeft:12}})]})}),e.jsx(ie,{children:e.jsx(se,{dataSource:R.map(t=>({...t,key:t.id})),columns:J,rowKey:"id",loading:M})}),e.jsx(ae,{destroyOnHidden:!1,open:z,onCancel:()=>y(!1),footer:null,title:o?"Edit Discount":"Create Discount",children:e.jsxs(l,{form:a,layout:"vertical",onFinish:K,onValuesChange:(t,i)=>{if(t.code!==void 0){const s=String(i.code||"").trim().toLowerCase()==="sibling"||b(String(i.code||"")).toLowerCase()==="sibling";C(s),s&&a.setFieldsValue({amountType:"fixed",appliesTo:"line_item",perAdditional:!0,perAdditionalAmounts:[10,10,10],amount:"0"})}t.active!==void 0&&u.current&&(window.clearTimeout(u.current),u.current=null)},initialValues:{active:!0,amountType:"fixed",appliesTo:"cart"},children:[e.jsx(l.Item,{name:"code",label:"Code",rules:[{required:!0}],children:e.jsx(S,{onBlur:()=>V(),onChange:t=>{const i=String(t.target.value||"").toUpperCase();a.setFieldsValue({code:i}),V(i)}})}),e.jsxs(l.Item,{label:"Discount ID (computed)",children:[e.jsx(S,{value:I||"",readOnly:!0}),I&&H&&e.jsx("div",{style:{color:"#d46b08",marginTop:6},children:"ID already exists; a unique suffix will be appended on save."}),!I&&e.jsx("div",{style:{color:"#777",marginTop:6},children:"ID will be generated from the discount code (e.g., sibling)."})]}),e.jsx(l.Item,{name:"amountType",label:"Amount Type",children:e.jsx(D,{options:[{value:"fixed",label:"fixed"},{value:"percent",label:"percent"}],disabled:h})}),h&&e.jsx("div",{style:{fontSize:12,color:"#666",marginTop:6},children:"Sibling discounts are always fixed amounts and apply per line item."}),e.jsx(l.Item,{name:"amount",label:"Amount",rules:[{required:!0}],children:e.jsx(S,{disabled:h})}),h&&e.jsx("div",{style:{fontSize:12,color:"#666",marginTop:6},children:"Sibling primary amount is fixed at $0 and cannot be changed."}),e.jsx(l.Item,{name:"appliesTo",label:"Applies To",children:e.jsx(D,{options:[{value:"cart",label:"cart"},{value:"line_item",label:"line_item"}],disabled:h})}),e.jsx(l.Item,{name:"allowedProgramTemplateIds",label:"Allowed Program Templates",children:e.jsx(D,{mode:"multiple",showSearch:{filterOption:(t,i)=>{const s=i?.label??i?.children;return String(s||"").toLowerCase().includes(String(t).toLowerCase())}},placeholder:"Select program templates",options:O.map(t=>({value:t.id,label:t.id})),style:{minWidth:240}})}),e.jsx("div",{style:{fontSize:12,color:"#777",marginTop:6},children:"Select program template IDs that this discount applies to. Leave blank to apply to all programs."}),e.jsx(l.Item,{label:"Apply per-additional",children:e.jsx(P,{checked:a.getFieldValue("perAdditional"),onChange:t=>a.setFieldsValue({perAdditional:t}),disabled:!0})}),e.jsx(l.Item,{shouldUpdate:(t,i)=>t.perAdditional!==i.perAdditional,noStyle:!0,children:()=>a.getFieldValue("perAdditional")?e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:8,fontSize:12,color:"#777"},children:"Configure per-additional discounts (first registration is not discounted)."}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 240px",gap:12,alignItems:"center"},children:[e.jsx("div",{children:"1st Athlete"}),e.jsx("div",{children:"$0"}),["2nd Athlete","3rd Athlete","4th+ Athlete"].map((i,s)=>e.jsxs(X.Fragment,{children:[e.jsx("div",{children:i}),e.jsx(l.Item,{name:["perAdditionalAmounts",s],style:{margin:0},children:e.jsx(ne,{style:{width:"100%"},formatter:n=>n==null?"":`$ ${n}`,parser:n=>{if(!n&&n!==0)return 0;const w=String(n).replace(/\$\s?|(,*)/g,""),r=Number(w);return Number.isNaN(r)?0:r},min:0})},`amt-${i}`)]},i))]})]}):null}),e.jsx(l.Item,{name:"active",label:"Active",valuePropName:"checked",children:e.jsx(P,{})}),e.jsx(l.Item,{name:"description",label:"Description",children:e.jsx(S.TextArea,{})}),e.jsx(l.Item,{children:e.jsxs($,{children:[e.jsx(f,{htmlType:"submit",type:"primary",children:"Save"}),e.jsx(f,{onClick:()=>y(!1),children:"Cancel"})]})})]})})]})}export{Te as default};
