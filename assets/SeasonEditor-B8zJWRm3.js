import{j as e,l as v}from"./index-lWfxYzVq.js";import{r as y}from"./vendor-router-Ck4ZuSP9.js";import{s as x}from"./firebaseSeasons-BgcPTcUq.js";import{s as U}from"./slugify-IzZIKjBC.js";import{G as c,Q as W,a8 as f,W as S,X as h,I,a9 as F,d as w,ad as _,ay as G}from"./vendor-antd-CieyQibU.js";import{S as O}from"./season-CjhZh6iC.js";const Q=y.forwardRef(({season:s,onFinish:$,readOnly:p},R)=>{const[a]=c.useForm(),[M,k]=W.useMessage(),[T,b]=y.useState(null),[q,Y]=y.useState(!1);y.useImperativeHandle(R,()=>({submit:()=>a.submit(),reset:()=>a.resetFields()})),y.useEffect(()=>{s?a.setFieldsValue({name:s.name,seasonType:s.seasonType,year:s.year,startDate:s.startDate?f(s.startDate):void 0,registrationOpen:s.registrationOpen?f(s.registrationOpen):void 0,registrationClose:s.registrationClose?f(s.registrationClose):void 0,description:s.description,status:s.status}):a.setFieldsValue({status:O.active})},[s,a]);const B=t=>{if(!t)return;const r=t.format("YYYY-MM-DD"),i=x.deriveSeasonMeta(r);a.setFieldsValue({startDate:t,seasonType:i.type,year:i.year}),a.setFields([{name:"startDate",errors:[]}]);try{a.validateFields(["registrationClose"])}catch(o){v.error("Failed to validate fields",o)}},j=y.useRef(void 0);y.useEffect(()=>()=>{j.current&&clearTimeout(j.current)},[]);const P=t=>{p||(j.current&&clearTimeout(j.current),j.current=window.setTimeout(()=>{(async()=>(await V(t),await N(t)))()},300))};async function V(t){try{if(s){b(s.id),Y(!1);return}const r=t||a.getFieldsValue();let i=r.seasonType,o=r.year;const l=r.startDate;if(l&&typeof l.format=="function"){const n=x.deriveSeasonMeta(l.format("YYYY-MM-DD"));i=n.type,o=n.year}if(i&&o){const n=U(`${o}-${i}`);b(n);const C=await x.getSeasonById(n);Y(!!C&&C.id!==s?.id)}else b(null),Y(!1)}catch(r){v.error("Error computing preview id",r),b(null),Y(!1)}}const A=t=>{const r=t.seasonType||t.seasonType||"";return`${r?r.charAt(0).toUpperCase()+r.slice(1):""} ${t.year}`.trim()},N=async t=>{if(!p){try{const r=t||a.getFieldsValue(),i=(r.name||"").trim(),o=r.startDate;let l=r.seasonType,n=r.year;if(o){const u=x.deriveSeasonMeta(o.format("YYYY-MM-DD"));l=u.type,n=u.year}const E=(await x.getSeasons()).filter(u=>u.id!==s?.id);if(i){const u=E.filter(d=>(d.name||"").trim().toLowerCase()===i.toLowerCase());if(u.length>0){const d=u.sort((g,D)=>new Date(g.createdAt||0).getTime()-new Date(D.createdAt||0).getTime())[0],m=A(d);return a.setFields([{name:"name",errors:[`Conflicts with ${m}`]}]),M.error(`Name conflicts with ${m}`),!0}else a.setFields([{name:"name",errors:[]}])}if(l&&n){const u=E.filter(d=>{try{if(d.startDate){const m=x.deriveSeasonMeta(d.startDate);return m.type===l&&m.year===n}return d.seasonType===l&&d.year===n}catch(m){return v.error("Error deriving season meta for duplicate check",m),d.seasonType===l&&d.year===n}});if(u.length>0){const d=u.sort((g,D)=>{const L=g.startDate?f(g.startDate).valueOf():g.createdAt?f(g.createdAt).valueOf():0,H=D.startDate?f(D.startDate).valueOf():D.createdAt?f(D.createdAt).valueOf():0;return L-H})[0],m=A(d);return a.setFields([{name:"seasonType",errors:[`Conflicts with ${m}`]}]),M.error(`${m} already exists`),!0}else a.setFields([{name:"seasonType",errors:[]}])}}catch(r){v.error("Duplicate check failed",r)}return!1}};return e.jsxs("div",{children:[k,e.jsxs(c,{form:a,layout:"vertical",onFinish:$,onValuesChange:(t,r)=>{(t.startDate||t.seasonType||t.year)&&P(r)},children:[e.jsxs(S,{gutter:12,children:[e.jsx(h,{span:12,children:e.jsx(c.Item,{name:"name",label:"Season Name",rules:[{required:!0,message:"Please enter season name"}],children:e.jsx(I,{placeholder:"e.g., Spring 2026",disabled:!!p,onBlur:()=>P()})})}),e.jsx(h,{span:12,children:e.jsxs(c.Item,{label:"Season ID (computed)",children:[e.jsx(I,{value:T||"",readOnly:!0}),T&&q&&e.jsx("div",{style:{color:"#d46b08",marginTop:6},children:"ID already exists; a unique suffix will be appended on save."}),!T&&e.jsx("div",{style:{color:"#777",marginTop:6},children:"ID will be generated from year and season type (e.g., 2026-spring)."})]})})]}),e.jsx(S,{gutter:12,children:e.jsx(h,{span:12,children:e.jsx(c.Item,{name:"startDate",label:"Start Date",rules:[{required:!0,message:"Please select start date"}],children:e.jsx(F,{allowClear:!1,style:{width:"100%"},format:"YYYY-MM-DD",onChange:B,disabled:!!p})})})}),e.jsxs(S,{gutter:12,children:[e.jsx(h,{span:12,children:e.jsx(c.Item,{name:"registrationOpen",label:"Registration Open",rules:[{required:!0,message:"Please select registration start"},({getFieldValue:t})=>({validator(r,i){const o=t("registrationClose");if(!i)return Promise.resolve();if(o&&i.isAfter(o,"day"))return Promise.reject(new Error("Registration open must be before registration close"));const l=t("year");if(l){const n=f(`${l-1}-01-01`);if(i.isBefore(n,"day"))return Promise.reject(new Error(`Registration open cannot be earlier than ${n.format("YYYY-MM-DD")}`))}return Promise.resolve()}})],children:e.jsx(F,{allowClear:!1,style:{width:"100%"},format:"YYYY-MM-DD",disabled:!!p,onChange:()=>{try{a.validateFields(["registrationClose"])}catch(t){v.error("Failed to validate fields",t)}}})})}),e.jsx(h,{span:12,children:e.jsx(c.Item,{name:"registrationClose",label:"Registration Close",rules:[{required:!0,message:"Please select registration close"},({getFieldValue:t})=>({validator(r,i){const o=t("registrationOpen");return i&&o&&i.isBefore(o,"day")?Promise.reject(new Error("Registration close must be after registration open")):Promise.resolve()}})],children:e.jsx(F,{allowClear:!1,style:{width:"100%"},format:"YYYY-MM-DD",disabled:!!p,onChange:()=>{try{a.validateFields(["registrationOpen"])}catch(t){v.error("Failed to validate fields",t)}}})})})]}),e.jsxs(S,{gutter:12,children:[e.jsx(h,{span:12,children:e.jsx(c.Item,{name:"seasonType",label:"Season Type",tooltip:"Derived from start date",children:e.jsxs(w,{placeholder:"(Derived from start date)",disabled:!0,children:[e.jsx(w.Option,{value:"spring",children:"Spring"}),e.jsx(w.Option,{value:"summer",children:"Summer"}),e.jsx(w.Option,{value:"fall",children:"Fall"}),e.jsx(w.Option,{value:"winter",children:"Winter"})]})})}),e.jsx(h,{span:12,children:e.jsx(c.Item,{name:"year",label:"Year",tooltip:"Derived from start date",children:e.jsx(_,{min:2020,max:2099,style:{width:"100%"},placeholder:"(Derived from start date)",disabled:!0})})})]}),e.jsx(c.Item,{name:"description",label:"Description",children:e.jsx(I.TextArea,{rows:3,placeholder:"Season details",disabled:!!p})}),e.jsx(c.Item,{name:"status",label:"Status",rules:[{required:!0}],children:e.jsx(G,{options:Object.entries(O).map(([t,r])=>({label:t.charAt(0).toUpperCase()+t.slice(1),value:r})),disabled:!!p})})]})]})});Q.displayName="SeasonEditor";export{Q as S};
