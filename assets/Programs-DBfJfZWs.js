import{j as t,l as g}from"./index-lWfxYzVq.js";import{r as o,u as pe}from"./vendor-router-Ck4ZuSP9.js";import{a as ue}from"./vendor-redux-BbD-gcRX.js";import{p as P,a as xe}from"./firebasePrograms-DQfL_YhU.js";import{s as ge}from"./firebaseSeasons-BgcPTcUq.js";import{S as C}from"./season-CjhZh6iC.js";import{G as r,x as je,Q as p,S as u,B as m,aa as ye,ab as Se,ac as fe,H as be,V as ve,a2 as we,a8 as d,M as L,d as i,I as W,a9 as M,ak as H,ad as Q,a0 as _,af as Ie,ag as Pe,ah as De}from"./vendor-antd-CieyQibU.js";import{n as ke,g as Ce,a as Me,b as Oe}from"./season-wVjdxr9p.js";import{A as Ee}from"./AdminPageHeader-BidreVSQ.js";import"./vendor-react-Ck9bq5u-.js";import"./vendor-firebase-BzUsRx-X.js";import"./slugify-IzZIKjBC.js";import"./firebaseTeams-DYGNnM-E.js";const{Title:J,Text:h}=je,{TextArea:Ye}=W,Qe=o.forwardRef(function(Fe,X){const O=pe(),{role:F,user:T}=ue(e=>e.auth),[x,b]=o.useState([]),[j,G]=o.useState([]),[R,B]=o.useState([]),[v,$]=o.useState("all"),[y,z]=o.useState([]),[Z,E]=o.useState(!1),[Y,V]=o.useState(null),[N,q]=o.useState(!0),[ee,w]=o.useState(!1),[I,K]=o.useState(null),[l]=r.useForm();if(o.useImperativeHandle(X,()=>({form:l}),[l]),F!=="admin"&&F!=="owner")return t.jsxs("div",{style:{padding:"64px",textAlign:"center"},children:[t.jsx(J,{level:2,type:"danger",children:"Access Denied"}),t.jsx(h,{type:"secondary",children:"You need admin or owner privileges to access this page."})]});o.useEffect(()=>{U(),te()},[]);const U=async()=>{q(!0);try{const e=await P.getPrograms();b(e)}catch(e){g.error("❌ Error loading programs:",e),p.error("Failed to load programs")}finally{q(!1)}},te=async()=>{try{const e=await ge.getSeasons();G(e);try{const s=await xe.getTemplates();B(s||[])}catch(s){g.error("Error loading templates",s),B([])}const a=e.find(s=>s.status===C.active);a&&v==="all"&&$(a.id)}catch(e){g.error("Error loading seasons:",e),G([])}},ae=e=>{z(e)},se=()=>{V(null),E(!0)},re=async()=>{if(!(!Y||y.length===0))try{const e=j.find(s=>s.id===Y);if(!e)throw new Error("Season not found");await P.bulkUpdatePrograms(y,{seasonId:e.id,year:e.year,season:e.seasonType});const a=x.map(s=>y.includes(s.id)?{...s,seasonId:e.id,season:e.seasonType,year:e.year,updatedAt:new Date().toISOString()}:s);b(a),z([]),E(!1),p.success("Programs moved to selected season")}catch(e){g.error("Bulk move failed",e),p.error("Failed to move programs")}},ie=()=>{K(null),l.resetFields();const e=d();l.setFieldsValue({status:!0,registrationOpen:e,registrationClose:e.add(3,"month")}),w(!0)},ne=e=>{O(`/admin/programs/${e.id}`)},le=e=>{O(`/admin/programs/${e.id}/teams`)},oe=e=>{K(null),l.setFieldsValue({...e,name:`${e.name} (Copy)`,active:e.active,birthDateStart:e.birthDateStart?d(e.birthDateStart):null,birthDateEnd:e.birthDateEnd?d(e.birthDateEnd):null,registrationOpen:d(e.registrationOpen),registrationClose:d(e.registrationClose)}),w(!0)},de=async e=>{try{await P.deleteProgram(e),b(x.filter(a=>a.id!==e)),p.success("Program deleted successfully")}catch(a){g.error("❌ Error deleting program:",a),p.error("Failed to delete program")}},ce=async e=>{try{const a=d(),s=e.registrationOpen||a,c=e.registrationClose||s.add(3,"month"),n={...e,active:e.active||!1,birthDateStart:e.birthDateStart?.format("YYYY-MM-DD"),birthDateEnd:e.birthDateEnd?.format("YYYY-MM-DD"),registrationOpen:s.toISOString(),registrationClose:c.toISOString()};if(I)await P.updateProgram(I.id,n),b(x.map(S=>S.id===I.id?{...S,...n,updatedAt:new Date().toISOString()}:S)),p.success("Program updated successfully");else{const A={id:await P.createProgram(n,T?.uid||""),...n,currentRegistrants:0,totalPayments:0,questions:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),createdBy:T?.uid||""};b([...x,A]),p.success("Program created successfully")}w(!1),l.resetFields()}catch(a){g.error("❌ Error saving program:",a),p.error("Failed to save program")}},me=v==="all"?x:v==="unassigned"?x.filter(e=>!e.seasonId):x.filter(e=>e.seasonId===v),he=[{title:"Status",key:"active",render:e=>t.jsx(_,{color:e.active?"green":"red",children:e.active?"Active":"Inactive"})},{title:"Program Name",key:"name",render:e=>t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:500},children:e.name}),t.jsx(h,{type:"secondary",children:e.sport}),(e.birthDateStart||e.birthDateEnd)&&t.jsx("div",{children:t.jsxs(h,{type:"secondary",style:{fontSize:"12px"},children:["Birth: ",e.birthDateStart?d(e.birthDateStart).format("MMM YYYY"):"—"," to ",e.birthDateEnd?d(e.birthDateEnd).format("MMM YYYY"):"—"]})}),(e.minGrade!==void 0||e.maxGrade!==void 0)&&t.jsx("div",{children:t.jsxs(h,{type:"secondary",style:{fontSize:"12px"},children:["Max Grade: ",e.maxGrade!==void 0?e.maxGrade===0?"K":e.maxGrade:"—",e.allowGradeExemption&&t.jsx(h,{type:"warning",children:" (exemptions allowed)"})]})})]})},{title:"Registration Open",dataIndex:"registrationOpen",key:"registrationOpen",render:e=>d(e).format("MMM D, YYYY")},{title:"Registration Close",dataIndex:"registrationClose",key:"registrationClose",render:e=>d(e).format("MMM D, YYYY")},{title:"Base Price",dataIndex:"basePrice",key:"basePrice",render:e=>`$${(e||0).toFixed(2)}`},{title:"Registrants",key:"registrants",render:e=>t.jsxs("div",{children:[t.jsx(h,{children:e.currentRegistrants??0}),e.maxParticipants!=null&&t.jsxs(h,{type:"secondary",children:["/",e.maxParticipants]})]})},{title:"Season",key:"season",render:e=>{const a=j.find(s=>s.id===e.seasonId);return a?t.jsx(_,{children:a.name}):t.jsx(h,{type:"secondary",children:"—"})}},{title:"Payments",dataIndex:"totalPayments",key:"totalPayments",render:e=>`$${(e||0).toFixed(2)}`},{title:"Actions",key:"actions",render:e=>t.jsxs(u,{children:[t.jsx(m,{size:"small",icon:t.jsx(Ie,{}),onClick:()=>{ne(e)},children:"Edit"}),t.jsx(m,{size:"small",onClick:()=>{le(e)},children:"Teams"}),t.jsx(m,{size:"small",onClick:()=>{oe(e)},children:"Duplicate"}),t.jsx(Pe,{title:"Delete Program",description:e.currentRegistrants>0?"Cannot delete program with existing registrants":"Are you sure you want to delete this program?",onConfirm:()=>de(e.id),okText:"Yes",cancelText:"No",disabled:e.currentRegistrants>0,children:t.jsx(m,{size:"small",danger:!0,icon:t.jsx(De,{}),disabled:e.currentRegistrants>0,children:"Delete"})})]})}];return t.jsxs("div",{className:"page-container full-width",children:[t.jsx(Ee,{title:t.jsxs(t.Fragment,{children:[t.jsx(J,{level:2,style:{margin:0},children:"Programs"}),t.jsx(h,{type:"secondary",children:"Manage sports programs and activities"})]}),actions:t.jsx(t.Fragment,{children:t.jsxs(u,{children:[t.jsx(m,{icon:t.jsx(ye,{}),onClick:U,loading:N,children:"Refresh"}),t.jsx(m,{onClick:()=>O("/admin/seasons"),children:"Manage Seasons"}),t.jsx(m,{onClick:se,disabled:y.length===0,children:"Move Selected"}),t.jsx(m,{type:"primary",icon:t.jsx(Se,{}),onClick:ie,children:"Add Program"})]})})}),t.jsx("div",{style:{marginTop:12},children:(()=>{const e=[{key:"all",label:"All Seasons"},...j.map(a=>({key:a.id,label:`${a.name}${a.status===C.archived?" (Archived)":""}`})),{key:"unassigned",label:"Unassigned"}];return t.jsx(fe,{activeKey:v,onChange:a=>$(a),items:e})})()}),t.jsx(be,{title:"Program Directory",children:t.jsx(ve,{spinning:N,children:t.jsx(we,{rowSelection:{selectedRowKeys:y,onChange:ae},columns:he,dataSource:me,rowKey:"id",pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,a)=>`${a[0]}-${a[1]} of ${e} programs`}})})}),t.jsx(L,{title:"Move selected programs to season",open:Z,onCancel:()=>E(!1),onOk:re,children:t.jsxs(r,{layout:"vertical",children:[t.jsx(r.Item,{label:"Target Season",children:t.jsx(i,{value:Y||void 0,onChange:e=>V(e),placeholder:"Select season",children:j.map(e=>t.jsxs(i.Option,{value:e.id,children:[e.name," ",e.status===C.archived?"(Archived)":""]},e.id))})}),t.jsx("div",{children:t.jsxs("small",{children:[y.length," program(s) will be moved."]})})]})}),t.jsx(L,{title:I?"Edit Program":"Add New Program",open:ee,onCancel:()=>{w(!1),l.resetFields()},footer:null,width:800,children:t.jsxs(r,{form:l,layout:"vertical",onFinish:ce,children:[t.jsx(r.Item,{name:"name",label:"Program Name",rules:[{required:!0}],children:t.jsx(W,{placeholder:"e.g., Spring Baseball League"})}),t.jsxs(u,{style:{width:"100%"},size:"large",children:[t.jsx(r.Item,{name:"sport",label:"Sport",rules:[{required:!0}],children:t.jsxs(i,{placeholder:"Select sport",style:{width:150},children:[t.jsx(i.Option,{value:"baseball",children:"Baseball"}),t.jsx(i.Option,{value:"softball",children:"Softball"}),t.jsx(i.Option,{value:"basketball",children:"Basketball"}),t.jsx(i.Option,{value:"soccer",children:"Soccer"}),t.jsx(i.Option,{value:"tennis",children:"Tennis"}),t.jsx(i.Option,{value:"other",children:"Other"})]})}),t.jsx(r.Item,{name:"sexRestriction",label:"Sex",rules:[{required:!0}],children:t.jsxs(i,{placeholder:"Select restriction",style:{width:120},children:[t.jsx(i.Option,{value:"any",children:"Any"}),t.jsx(i.Option,{value:"male",children:"Male"}),t.jsx(i.Option,{value:"female",children:"Female"})]})}),t.jsx(r.Item,{name:"seasonId",label:"Season",children:t.jsx(i,{placeholder:"Select season",style:{width:150},children:j.filter(e=>e.status===C.active).map(e=>t.jsxs(i.Option,{value:e.id,children:[e.name," (",e.year,")"]},e.id))})}),t.jsx(r.Item,{name:"templateId",label:"Template",rules:[{required:!0,message:"Select a template"}],children:t.jsx(i,{placeholder:"Select template",style:{width:220},children:R.map(e=>t.jsxs(i.Option,{value:e.id,children:[e.sportId," — ",e.programType,e.sex?` (${e.sex})`:""]},e.id))})})]}),t.jsx(r.Item,{name:"description",label:"Description",children:t.jsx(Ye,{rows:3,placeholder:"Program description..."})}),t.jsxs(u,{style:{width:"100%"},size:"large",children:[t.jsx(r.Item,{name:"birthDateStart",label:"Earliest Birth Date",children:t.jsx(M,{placeholder:"Oldest allowed"})}),t.jsx(r.Item,{name:"birthDateEnd",label:"Latest Birth Date",children:t.jsx(M,{placeholder:"Youngest allowed"})})]}),t.jsxs(u,{style:{width:"100%"},size:"large",children:[t.jsx(r.Item,{noStyle:!0,shouldUpdate:(e,a)=>e.birthDateStart!==a.birthDateStart||e.allowGradeExemption!==a.allowGradeExemption,children:({getFieldValue:e})=>{const a=e("allowGradeExemption"),s=e("birthDateStart");if(a&&s)try{const c=e("seasonId");let n;if(c){const f=j.find(k=>k.id===c);f&&(n=ke(f))}if(!n){const f=d(),k=f.month()>=7;n={term:k?"fall":"spring",year:k?f.year()+1:f.year()}}const S=e("sport"),A=Ce(n,S),D=Me(s,A);D&&D>=0&&D<=12&&setTimeout(()=>{l.setFieldsValue({maxGrade:D})},0)}catch(c){g.error("Error calculating max grade from birth date",c);const n=Oe(s);n>=0&&n<=12&&setTimeout(()=>{l.setFieldsValue({maxGrade:n})},0)}return t.jsx(r.Item,{name:"maxGrade",label:"Max Grade",children:t.jsxs(i,{placeholder:"Max grade",style:{width:120},children:[t.jsx(i.Option,{value:0,children:"Kindergarten"}),Array.from({length:12},(c,n)=>t.jsxs(i.Option,{value:n+1,children:["Grade ",n+1]},n+1))]})})}}),t.jsx(r.Item,{name:"allowGradeExemption",label:"Allow Grade Exemption",valuePropName:"checked",children:t.jsx(H,{checkedChildren:"Yes",unCheckedChildren:"No"})})]}),t.jsxs(u,{style:{width:"100%"},size:"large",children:[t.jsx(r.Item,{name:"registrationOpen",label:"Registration Open",rules:[{required:!0}],children:t.jsx(M,{})}),t.jsx(r.Item,{name:"registrationClose",label:"Registration Close",rules:[{required:!0}],children:t.jsx(M,{})})]}),t.jsxs(u,{style:{width:"100%"},size:"large",children:[t.jsx(r.Item,{noStyle:!0,shouldUpdate:(e,a)=>e.templateId!==a.templateId,children:()=>{const e=l.getFieldValue("templateId"),a=R.find(s=>s.id===e);if(a){const s=l.getFieldValue("basePrice");(s==null||s==="")&&a.defaultBaseFee!==void 0&&l.setFieldsValue({basePrice:a.defaultBaseFee});const c=l.getFieldValue("sexRestriction");(!c||c==="")&&a.sex&&l.setFieldsValue({sexRestriction:a.sex})}return t.jsx(r.Item,{name:"basePrice",label:"Base Price ($)",rules:[{required:!0}],children:t.jsx(Q,{min:0,step:.01,placeholder:"0.00"})})}}),t.jsx(r.Item,{name:"maxParticipants",label:"Max Participants",children:t.jsx(Q,{min:1,placeholder:"Unlimited"})}),t.jsx(r.Item,{name:"active",label:"Active Program",valuePropName:"checked",children:t.jsx(H,{checkedChildren:"Active",unCheckedChildren:"Inactive"})})]}),t.jsx(r.Item,{style:{marginBottom:0,textAlign:"right"},children:t.jsxs(u,{children:[t.jsx(m,{onClick:()=>{w(!1),l.resetFields()},children:"Cancel"}),t.jsx(m,{type:"primary",htmlType:"submit",children:I?"Update Program":"Create Program"})]})})]})})]})});export{Qe as default};
